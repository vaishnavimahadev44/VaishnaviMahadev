<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>E-Visa Admin Panel</title>
recaptcha
    <script src="auth.js" defer></script>
    <script>
        (function(){
            // Wait for auth.js to load before checking authentication
            function checkAuth() {
                try {
                    var params = new URLSearchParams(window.location.search);
                    if (params.get('logout') === '1' && window.Auth && typeof window.Auth.logout === 'function') {
                        window.Auth.logout();
                    }

                    var isAuthed = false;
                    try {
                        isAuthed = !!(window.Auth && typeof window.Auth.isAuthenticated === 'function' && window.Auth.isAuthenticated());
                    } catch (e) { 
                        console.log('Auth not ready yet, retrying...');
                        setTimeout(checkAuth, 100);
                        return;
                    }

                    if (!isAuthed) {
                        var cleanedSearch = window.location.search
                            .replace(/([?&])logout=1(&)?/, function(match, p1, p2){ return p2 ? p1 : ''; })
                            .replace(/([?&])&+/, '$1');
                        if (cleanedSearch === '?') cleanedSearch = '';
                        var next = encodeURIComponent(window.location.pathname + cleanedSearch + window.location.hash);
                        window.location.replace('login.html?next=' + next);
                    }
                } catch (e) {
                    console.error('Auth check error:', e);
                }
            }
            
           
            checkAuth();
        })();
    </script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/tinymce/6.7.2/tinymce.min.js"></script>
    <link href="https://cdn.quilljs.com/1.3.6/quill.snow.css" rel="stylesheet">
    <script src="https://cdn.quilljs.com/1.3.6/quill.min.js"></script>
    <style>
        :root {
            --primary: #0a2540;
            --primary-light: #1e3a8a;
            --secondary: #6366f1;
            --accent: #f59e0b;
            --success: #10b981;
            --warning: #f59e0b;
            --error: #ef4444;
            --dark: #0f172a;
            --dark-gray: #475569;
            --gray: #64748b;
            --light-gray: #94a3b8;
            --lighter-gray: #e2e8f0;
            --light: #ffffff;
            --off-white: #f8fafc;
            --gradient: linear-gradient(135deg, var(--primary), var(--secondary));
            --shadow: 0 1px 3px 0 rgb(0 0 0 / 0.1), 0 1px 2px -1px rgb(0 0 0 / 0.1);
            --shadow-lg: 0 10px 15px -3px rgb(0 0 0 / 0.1), 0 4px 6px -4px rgb(0 0 0 / 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--off-white);
            color: var(--primary);
            line-height: 1.6;
        }

        .admin-container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--primary);
            color: var(--light);
            padding: 2rem 0;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 0 2rem 2rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            margin-bottom: 2rem;
        }

        .sidebar-header h1 {
            font-size: 1.5rem;
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 0.75rem;
        }

        .nav-menu {
            list-style: none;
        }

        .nav-item {
            margin-bottom: 0.5rem;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem 2rem;
            color: var(--light-gray);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover,
        .nav-link.active {
            background: rgba(255, 255, 255, 0.1);
            color: var(--light);
            border-left-color: var(--secondary);
        }

        .main-content {
            flex: 1;
            margin-left: 280px;
            padding: 2rem;
        }

        .page-header {
            margin-bottom: 2rem;
        }

        .page-title {
            font-size: 2rem;
            font-weight: 700;
            margin-bottom: 0.5rem;
        }

        .page-subtitle {
            color: var(--gray);
            font-size: 1.1rem;
        }

        .card {
            background: var(--light);
            border-radius: 12px;
            padding: 2rem;
            box-shadow: var(--shadow);
            margin-bottom: 2rem;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--lighter-gray);
        }

        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .btn {
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
        }

        .btn-primary {
            background: var(--primary);
            color: var(--light);
        }

        .btn-primary:hover {
            background: var(--primary-light);
            transform: translateY(-1px);
        }

        .btn-success {
            background: var(--success);
            color: var(--light);
        }

        .btn-success:hover {
            background: #059669;
            transform: translateY(-1px);
        }

        .btn-danger {
            background: var(--error);
            color: var(--light);
        }

        .btn-danger:hover {
            background: #dc2626;
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--light);
            color: var(--primary);
            border: 2px solid var(--primary);
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: var(--light);
        }

        .form-group {
            margin-bottom: 1.5rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 600;
            color: var(--primary);
        }

        .form-input {
            width: 100%;
            padding: 0.75rem;
            border: 2px solid var(--lighter-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .form-input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .form-textarea {
            min-height: 100px;
            resize: vertical;
        }

        .preview-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 2rem;
            margin-top: 1rem;
        }

        .preview-section {
            background: var(--off-white);
            border: 1px solid var(--lighter-gray);
            border-radius: 8px;
            padding: 1.5rem;
        }

        .preview-section h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.1rem;
            font-weight: 600;
        }

        .preview-section .form-group {
            margin-bottom: 1rem;
        }

        .preview-section .form-input {
            background: var(--light);
            border: 1px solid var(--light-gray);
        }

        .preview-section .form-input:focus {
            border-color: var(--secondary);
        }

        .visa-list {
            list-style: none;
        }

        .visa-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .visa-item {
            background: var(--light);
            border: 1px solid var(--lighter-gray);
            border-radius: 12px;
            padding: 1.5rem;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .visa-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
            border-color: var(--secondary);
        }

        .visa-item.active {
            border-color: var(--success);
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.05), rgba(16, 185, 129, 0.02));
        }

        .visa-item.inactive {
            opacity: 0.6;
            border-color: var(--light-gray);
        }

        .visa-status {
            position: absolute;
            top: 1rem;
            right: 1rem;
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .visa-status.active {
            background: var(--success);
            color: var(--light);
        }

        .visa-status.inactive {
            background: var(--light-gray);
            color: var(--dark);
        }

        .visa-header {
            margin-bottom: 1rem;
            padding-right: 80px;
        }

        .visa-name {
            font-size: 1.1rem;
            font-weight: 700;
            color: var(--primary);
            margin-bottom: 0.5rem;
        }

        .visa-description {
            color: var(--gray);
            font-size: 0.9rem;
            line-height: 1.5;
            margin-bottom: 1rem;
        }

        .visa-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 1rem;
            margin-bottom: 1.5rem;
        }

        .visa-detail {
            text-align: center;
            padding: 0.75rem;
            background: var(--off-white);
            border-radius: 8px;
        }

        .visa-detail-label {
            font-size: 0.75rem;
            color: var(--gray);
            text-transform: uppercase;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .visa-detail-value {
            font-size: 1rem;
            font-weight: 700;
            color: var(--primary);
        }

        .visa-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .visa-search {
            margin-bottom: 2rem;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 0.75rem 1rem;
            border: 2px solid var(--lighter-gray);
            border-radius: 8px;
            font-size: 1rem;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            outline: none;
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
        }

        .visa-filters {
            display: flex;
            gap: 1rem;
            margin-bottom: 2rem;
            flex-wrap: wrap;
        }

        .filter-btn {
            padding: 0.5rem 1rem;
            border: 2px solid var(--lighter-gray);
            background: var(--light);
            border-radius: 6px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .filter-btn:hover,
        .filter-btn.active {
            border-color: var(--secondary);
            background: var(--secondary);
            color: var(--light);
        }

        .visa-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-bottom: 2rem;
        }

        .visa-stat {
            background: var(--light);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            border: 1px solid var(--lighter-gray);
        }

        .visa-stat-number {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 0.25rem;
        }

        .visa-stat-label {
            font-size: 0.8rem;
            color: var(--gray);
            text-transform: uppercase;
            font-weight: 600;
        }

        .quick-add-option {
            padding: 1rem;
            border: 1px solid var(--lighter-gray);
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .quick-add-option:hover {
            background: var(--off-white);
            border-color: var(--secondary);
            transform: translateX(5px);
        }

        .quick-add-option strong {
            color: var(--primary);
            font-weight: 600;
        }

        .quick-add-option span {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .visa-info {
            flex: 1;
        }

        .visa-name {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .visa-description {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .visa-actions {
            display: flex;
            gap: 0.5rem;
        }

        .btn-sm {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: var(--light);
            border-radius: 12px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1.5rem;
            padding-bottom: 1rem;
            border-bottom: 1px solid var(--lighter-gray);
        }

        .modal-title {
            font-size: 1.25rem;
            font-weight: 600;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: var(--gray);
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: var(--lighter-gray);
            color: var(--primary);
        }

        .alert {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .alert-success {
            background: #d1fae5;
            color: #065f46;
            border: 1px solid #a7f3d0;
        }

        .alert-error {
            background: #fee2e2;
            color: #991b1b;
            border: 1px solid #fecaca;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: var(--light);
            padding: 1.5rem;
            border-radius: 12px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: var(--secondary);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: var(--gray);
            font-weight: 500;
        }

        .drag-handle {
            cursor: move;
            color: var(--gray);
            margin-right: 0.75rem;
        }

        .visa-item.dragging {
            opacity: 0.5;
            transform: rotate(5deg);
        }

        .export-section {
            background: var(--off-white);
            padding: 1.5rem;
            border-radius: 8px;
            margin-top: 1rem;
        }

        .export-buttons {
            display: flex;
            gap: 1rem;
            flex-wrap: wrap;
        }

        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
                transition: transform 0.3s ease;
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .mobile-menu-btn {
                display: block;
                position: fixed;
                top: 1rem;
                left: 1rem;
                z-index: 1001;
                background: var(--primary);
                color: var(--light);
                border: none;
                padding: 0.75rem;
                border-radius: 8px;
                cursor: pointer;
            }
        }

        .mobile-menu-btn {
            display: none;
        }

       
        .content-section {
            display: none;
        }

        .content-section.active {
            display: block;
        }

      
        .pagination {
            display: flex;
            justify-content: center;
            align-items: center;
            margin-top: 2rem;
            gap: 1rem;
        }

        .pagination button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-filters {
            margin-bottom: 1.5rem;
        }

         .chat-item {
            transition: all 0.3s ease;
        }

        .chat-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .chat-details-modal .visa-details {
            grid-template-columns: repeat(4, 1fr);
            gap: 1rem;
            margin-bottom: 1.5rem;
        }
        .chat-details-modal .visa-detail {
            text-align: center;
            padding: 1rem;
            background: var(--off-white);
            border-radius: 8px;
        }

        .chat-question, .chat-response {
            background: var(--off-white);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .chat-question {
            border-left: 4px solid var(--secondary);
        }                                                                      

        .chat-response {
            border-left: 4px solid var(--success);
        }

        .satisfaction-stars {
            color: #f59e0b;
        }

        .chat-actions {
            display: flex;
            gap: 0.5rem;
            justify-content: flex-end;
        }

        .chat-actions .btn-sm {
            padding: 0.5rem 0.75rem;
            font-size: 0.875rem;
        }

    
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .fa-spin {
            animation: spin 1s linear infinite;
        }

   
        .tox-tinymce {
            border: 2px solid var(--lighter-gray) !important;
            border-radius: 12px !important;
            transition: all 0.3s ease !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
            margin: 20px 0 !important;
        }

        .tox-tinymce:focus-within {
            border-color: var(--secondary) !important;
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1), 0 4px 12px rgba(0, 0, 0, 0.1) !important;
            transform: translateY(-1px) !important;
        }

 
        .tox .tox-toolbar {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
            border-bottom: 1px solid var(--lighter-gray) !important;
            padding: 8px 12px !important;
            border-radius: 10px 10px 0 0 !important;
        }

        .tox .tox-toolbar__group {
            border-right: 1px solid rgba(226, 232, 240, 0.6) !important;
            padding: 0 8px !important;
            margin: 0 4px !important;
        }

        .tox .tox-toolbar__group:last-child {
            border-right: none !important;
        }

        .tox .tox-tbtn {
            border-radius: 6px !important;
            margin: 2px !important;
            transition: all 0.2s ease !important;
            min-width: 32px !important;
            height: 32px !important;
        }

        .tox .tox-tbtn:hover {
            background: rgba(99, 102, 241, 0.1) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }

        .tox .tox-tbtn--enabled {
            background: rgba(99, 102, 241, 0.15) !important;
            color: var(--secondary) !important;
            font-weight: 600 !important;
        }

        .tox .tox-tbtn--enabled:hover {
            background: rgba(99, 102, 241, 0.25) !important;
        }

   
        .tox .tox-edit-area {
            background: var(--light) !important;
            border-radius: 0 0 10px 10px !important;
        }

        .tox .tox-edit-area__iframe {
            background: var(--light) !important;
            border-radius: 0 0 10px 10px !important;
        }

        
        .tox .tox-statusbar {
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
            border-top: 1px solid var(--lighter-gray) !important;
            border-radius: 0 0 10px 10px !important;
            padding: 8px 12px !important;
            font-size: 12px !important;
        }

        .tox .tox-statusbar__text-container {
            color: var(--gray) !important;
            font-weight: 500 !important;
        }


        .tox .tox-menu {
            background: var(--light) !important;
            border: 1px solid var(--lighter-gray) !important;
            border-radius: 12px !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
            padding: 8px 0 !important;
        }

        .tox .tox-collection__item {
            color: var(--primary) !important;
            padding: 10px 16px !important;
            margin: 2px 8px !important;
            border-radius: 6px !important;
            transition: all 0.2s ease !important;
        }

        .tox .tox-collection__item--active {
            background: var(--secondary) !important;
            color: var(--light) !important;
            font-weight: 600 !important;
        }

        .tox .tox-collection__item:hover {
            background: rgba(99, 102, 241, 0.1) !important;
            transform: translateX(2px) !important;
        }

        .tox .tox-selectfield {
            border-radius: 6px !important;
            border: 1px solid var(--lighter-gray) !important;
            background: var(--light) !important;
            padding: 4px 8px !important;
            margin: 2px !important;
        }

        .tox .tox-selectfield:hover {
            border-color: var(--secondary) !important;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1) !important;
        }

     
        .tox .tox-color-picker {
            border-radius: 8px !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
        }

      
        .tox .tox-quick-toolbar {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid var(--lighter-gray) !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        }

     
        .tox .tox-contextmenu {
            background: rgba(255, 255, 255, 0.95) !important;
            backdrop-filter: blur(10px) !important;
            border: 1px solid var(--lighter-gray) !important;
            border-radius: 8px !important;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1) !important;
        }

      
        @media (max-width: 768px) {
            .tox .tox-toolbar {
                padding: 6px 8px !important;
            }
            
            .tox .tox-toolbar__group {
                padding: 0 4px !important;
                margin: 0 2px !important;
            }
            
            .tox .tox-tbtn {
                min-width: 28px !important;
                height: 28px !important;
                margin: 1px !important;
            }
        }

     
        .ql-editor {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif !important;
            font-size: 16px !important;
            line-height: 1.6 !important;
            color: #333 !important;
            padding: 20px !important;
            min-height: 300px !important;
        }

        .ql-toolbar {
            border: 2px solid var(--lighter-gray) !important;
            border-radius: 12px 12px 0 0 !important;
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%) !important;
            padding: 12px !important;
        }

        .ql-container {
            border: 2px solid var(--lighter-gray) !important;
            border-top: none !important;
            border-radius: 0 0 12px 12px !important;
            background: var(--light) !important;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05) !important;
        }

        .ql-toolbar.ql-snow .ql-formats {
            margin-right: 15px !important;
        }

        .ql-toolbar.ql-snow button {
            border-radius: 6px !important;
            margin: 2px !important;
            transition: all 0.2s ease !important;
            min-width: 32px !important;
            height: 32px !important;
        }

        .ql-toolbar.ql-snow button:hover {
            background: rgba(99, 102, 241, 0.1) !important;
            transform: translateY(-1px) !important;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1) !important;
        }

        .ql-toolbar.ql-snow .ql-active {
            background: rgba(99, 102, 241, 0.15) !important;
            color: var(--secondary) !important;
        }

        .ql-toolbar.ql-snow .ql-picker {
            border-radius: 6px !important;
            border: 1px solid var(--lighter-gray) !important;
            background: var(--light) !important;
            padding: 4px 8px !important;
            margin: 2px !important;
        }

        .ql-toolbar.ql-snow .ql-picker:hover {
            border-color: var(--secondary) !important;
            box-shadow: 0 2px 4px rgba(99, 102, 241, 0.1) !important;
        }

        .ql-toolbar.ql-snow .ql-picker-options {
            border-radius: 8px !important;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
            border: 1px solid var(--lighter-gray) !important;
        }

       
        .file-manager-toolbar {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1rem;
            background: var(--light);
            border-radius: 12px;
            box-shadow: var(--shadow);
            margin-bottom: 1.5rem;
        }

        .toolbar-left, .toolbar-right {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .search-box {
            position: relative;
            display: flex;
            align-items: center;
        }

        .search-input {
            padding: 0.75rem 1rem 0.75rem 2.5rem;
            border: 2px solid var(--lighter-gray);
            border-radius: 8px;
            font-size: 0.9rem;
            width: 250px;
            transition: all 0.3s ease;
        }

        .search-input:focus {
            border-color: var(--secondary);
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.1);
            outline: none;
        }

        .search-icon {
            position: absolute;
            left: 0.75rem;
            color: var(--gray);
            font-size: 0.9rem;
        }

        .view-mode-select {
            padding: 0.75rem 1rem;
            border: 2px solid var(--lighter-gray);
            border-radius: 8px;
            background: var(--light);
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .view-mode-select:focus {
            border-color: var(--secondary);
            outline: none;
        }

        .file-breadcrumb {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            background: var(--light);
            border-radius: 8px;
            margin-bottom: 1.5rem;
            box-shadow: var(--shadow-sm);
        }

        .breadcrumb-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            color: var(--secondary);
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .breadcrumb-item:hover {
            background: rgba(99, 102, 241, 0.1);
        }

        .breadcrumb-path {
            color: var(--gray);
            font-family: monospace;
        }

        .file-manager-content {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 1.5rem;
            height: calc(100vh - 300px);
        }

        .file-sidebar {
            background: var(--light);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            height: fit-content;
        }

        .sidebar-section {
            margin-bottom: 2rem;
        }

        .sidebar-section h3 {
            font-size: 1rem;
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 1px solid var(--lighter-gray);
        }

        .quick-access-list {
            list-style: none;
        }

        .quick-access-list li {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: var(--gray);
        }

        .quick-access-list li:hover {
            background: rgba(99, 102, 241, 0.1);
            color: var(--secondary);
            transform: translateX(4px);
        }

        .file-type-filters {
            display: flex;
            flex-direction: column;
            gap: 0.75rem;
        }

        .filter-checkbox {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 6px;
            transition: all 0.3s ease;
        }

        .filter-checkbox:hover {
            background: rgba(99, 102, 241, 0.05);
        }

        .filter-checkbox input[type="checkbox"] {
            width: 16px;
            height: 16px;
            accent-color: var(--secondary);
        }

        .file-main-content {
            background: var(--light);
            border-radius: 12px;
            padding: 1.5rem;
            box-shadow: var(--shadow);
            overflow-y: auto;
        }

        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .file-grid.list-view {
            grid-template-columns: 1fr;
        }

        .file-item {
            background: var(--off-white);
            border: 2px solid var(--lighter-gray);
            border-radius: 12px;
            padding: 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .file-item:hover {
            border-color: var(--secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .file-item.selected {
            border-color: var(--secondary);
            background: rgba(99, 102, 241, 0.05);
        }

        .file-icon {
            width: 60px;
            height: 60px;
            margin: 0 auto 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 2rem;
            color: var(--secondary);
            background: rgba(99, 102, 241, 0.1);
            border-radius: 12px;
        }

        .file-info {
            text-align: center;
        }

        .file-name {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 0.5rem;
            word-break: break-word;
        }

        .file-meta {
            font-size: 0.8rem;
            color: var(--gray);
        }

        .file-actions {
            position: absolute;
            top: 0.5rem;
            right: 0.5rem;
            display: none;
            gap: 0.25rem;
        }

        .file-item:hover .file-actions {
            display: flex;
        }

        .file-action-btn {
            width: 28px;
            height: 28px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.9);
            color: var(--gray);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
        }

        .file-action-btn:hover {
            background: var(--secondary);
            color: var(--light);
            transform: scale(1.1);
        }

        .file-item.list-view {
            display: flex;
            align-items: center;
            gap: 1rem;
            padding: 1rem;
        }

        .file-item.list-view .file-icon {
            width: 40px;
            height: 40px;
            margin: 0;
            font-size: 1.5rem;
        }

        .file-item.list-view .file-info {
            text-align: left;
            flex: 1;
        }

        .file-item.list-view .file-actions {
            position: static;
            display: flex;
        }

    
        .badge {
            display: inline-block;
            padding: 0.25rem 0.5rem;
            font-size: 0.75rem;
            font-weight: 600;
            border-radius: 4px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }


        @keyframes slideIn {
            from {
                transform: translateX(100%);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        @keyframes slideOut {
            from {
                transform: translateX(0);
                opacity: 1;
            }
            to {
                transform: translateX(100%);
                opacity: 0;
            }
        }

     
        .file-upload-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .file-upload-modal.active {
            display: flex;
        }

        .file-upload-content {
            background: var(--light);
            border-radius: 16px;
            padding: 2rem;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: var(--shadow-xl);
        }

        .file-upload-area {
            border: 3px dashed var(--lighter-gray);
            border-radius: 12px;
            padding: 3rem 2rem;
            text-align: center;
            margin-bottom: 1.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .file-upload-area:hover,
        .file-upload-area.dragover {
            border-color: var(--secondary);
            background: rgba(99, 102, 241, 0.05);
        }

        .file-upload-icon {
            font-size: 3rem;
            color: var(--gray);
            margin-bottom: 1rem;
        }

        .file-upload-text {
            font-size: 1.1rem;
            color: var(--gray);
            margin-bottom: 0.5rem;
        }

        .file-upload-hint {
            font-size: 0.9rem;
            color: var(--light-gray);
        }

        .file-preview {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1.5rem;
        }

        .file-preview-item {
            background: var(--off-white);
            border-radius: 8px;
            padding: 1rem;
            text-align: center;
            position: relative;
        }

        .file-preview-item .file-icon {
            width: 40px;
            height: 40px;
            margin: 0 auto 0.5rem;
            font-size: 1.5rem;
        }

        .file-preview-item .file-name {
            font-size: 0.8rem;
            margin-bottom: 0.25rem;
        }

        .file-preview-item .file-size {
            font-size: 0.7rem;
            color: var(--gray);
        }

        .file-preview-item .remove-file {
            position: absolute;
            top: 0.25rem;
            right: 0.25rem;
            width: 20px;
            height: 20px;
            border: none;
            border-radius: 50%;
            background: var(--error);
            color: var(--light);
            cursor: pointer;
            font-size: 0.7rem;
        }

       
        @media (max-width: 768px) {
            .file-manager-content {
                grid-template-columns: 1fr;
            }

            .file-sidebar {
                order: 2;
            }

            .file-main-content {
                order: 1;
            }

            .toolbar-left, .toolbar-right {
                flex-direction: column;
                gap: 0.5rem;
            }

            .search-input {
                width: 100%;
            }

            .file-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            }
        }
    </style>
</head>
<body>
    <button class="mobile-menu-btn" id="mobileMenuBtn">
        <i class="fas fa-bars"></i>
    </button>

    <div class="admin-container">
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h1>
                    <i class="fas fa-passport"></i>
                    E-Visa Admin
                </h1>
            </div>
            <nav>
                <ul class="nav-menu">
                    <li class="nav-item">
                        <a href="#dashboard" class="nav-link active" data-section="dashboard">
                            <i class="fas fa-tachometer-alt"></i>
                            Dashboard
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#faqs" class="nav-link" data-section="faqs">
                            <i class="fas fa-question-circle"></i>
                            FAQs
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#visa-types" class="nav-link" data-section="visa-types">
                            <i class="fas fa-list"></i>
                            Visa Types
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#packages" class="nav-link" data-section="packages">
                            <i class="fas fa-box"></i>
                            Packages
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#dependent-costs" class="nav-link" data-section="dependent-costs">
                            <i class="fas fa-users"></i>
                            Dependent Costs
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#chat-tracking" class="nav-link" data-section="chat-tracking">
                            <i class="fas fa-comments"></i>
                            Chat Tracking
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#dropdowns" class="nav-link" data-section="dropdowns">
                            <i class="fas fa-list-ul"></i>
                            Dropdown Options
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#applicant-dropdowns" class="nav-link" data-section="applicant-dropdowns">
                            <i class="fas fa-users"></i>
                            Applicant Dropdowns
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#file-manager" class="nav-link" data-section="file-manager">
                            <i class="fas fa-folder-open"></i>
                            File Manager
                        </a>
                    </li>
                    <li class="nav-item">
                        <a href="#settings" class="nav-link" data-section="settings">
                            <i class="fas fa-cog"></i>
                            Settings
                        </a>
                    </li>
                </ul>
            </nav>
        </aside>

        <main class="main-content">
          
            <section id="dashboard" class="content-section active">
                <div class="page-header">
                    <h1 class="page-title">Dashboard</h1>
                    <p class="page-subtitle">Overview of your UK Visa application system</p>
                    <div style="margin-top: 1rem;">
                        <button class="btn btn-secondary" onclick="location.href='FAQ.html'">FAQ</button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalVisas">15</div>
                        <div class="stat-label">Visa Types</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalPackages">3</div>
                        <div class="stat-label">Packages</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalApplications">0</div>
                        <div class="stat-label">Applications</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="successRate">98%</div>
                        <div class="stat-label">Success Rate</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Quick Actions</h2>
                    </div>
                    <div class="export-buttons">
                        <button class="btn btn-primary" onclick="exportVisaTypes()">
                            <i class="fas fa-download"></i>
                            Export Visa Types
                        </button>
                        <button class="btn btn-secondary" onclick="importVisaTypes()">
                            <i class="fas fa-upload"></i>
                            Import Visa Types
                        </button>
                        <button class="btn btn-success" onclick="backupData()">
                            <i class="fas fa-save"></i>
                            Backup Data
                        </button>
                        <button class="btn btn-primary" onclick="exportDropdownOptionsToFile()">
                            <i class="fas fa-download"></i>
                            Export Dropdown Options
                        </button>
                        
                    </div>
                </div>
            </section>

        
            <section id="visa-types" class="content-section">
                <div class="page-header">
                    <h1 class="page-title">Manage Visa Types</h1>
                    <p class="page-subtitle">Add, edit, or remove unlimited visa types for the application form</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Visa Types Overview</h2>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-primary" onclick="openVisaModal()">
                                <i class="fas fa-plus"></i>
                                Add New Visa Type
                            </button>
                            <button class="btn btn-secondary" onclick="showQuickAddMenu()">
                                <i class="fas fa-bolt"></i>
                                Quick Add
                            </button>
                        </div>
                    </div>
                    
               
                    <div class="visa-stats">
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="totalVisasCount">0</div>
                            <div class="visa-stat-label">Total Visa Types</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="activeVisasCount">0</div>
                            <div class="visa-stat-label">Active</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="inactiveVisasCount">0</div>
                            <div class="visa-stat-label">Inactive</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="avgProcessingTime">0</div>
                            <div class="visa-stat-label">Avg Processing (Days)</div>
                        </div>
                    </div>

                
                    <div class="visa-search">
                        <input type="text" class="search-input" id="visaSearch" placeholder="Search visa types..." onkeyup="filterVisas()">
                    </div>

                    <div class="visa-filters">
                        <button class="filter-btn active" onclick="filterVisas('all')">All</button>
                        <button class="filter-btn" onclick="filterVisas('active')">Active Only</button>
                        <button class="filter-btn" onclick="filterVisas('inactive')">Inactive Only</button>
                        <button class="filter-btn" onclick="sortVisas('name')">Sort by Name</button>
                        <button class="filter-btn" onclick="sortVisas('price')">Sort by Price</button>
                        <button class="filter-btn" onclick="sortVisas('processing')">Sort by Processing Time</button>
                        <button class="filter-btn" onclick="bulkActivate()" style="background: var(--success); color: var(--light);">Bulk Activate</button>
                        <button class="filter-btn" onclick="bulkDeactivate()" style="background: var(--warning); color: var(--light);">Bulk Deactivate</button>
                    </div>

                    <div id="visaList">
                       
                    </div>
                </div>
            </section>

            
            <section id="packages" class="content-section">
                <div class="page-header">
                    <h1 class="page-title">Manage Packages</h1>
                    <p class="page-subtitle">Configure pricing packages for visa applications</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Packages</h2>
                        <div style="display: flex; gap: 1rem; align-items: center;">
                            <select class="form-input" id="packageFilter" style="width: 180px;">
                                <option value="all">Show: All</option>
                                <option value="active">Show: Active Only</option>
                                <option value="inactive">Show: Inactive Only</option>
                            </select>
                            <button class="btn btn-primary" onclick="openPackageModal()">
                                <i class="fas fa-plus"></i>
                                Add Package
                            </button>
                        </div>
                    </div>
                    <div id="packageList">
                        
                    </div>
                </div>
            </section>

       
            <section id="dependent-costs" class="content-section">
                <div class="page-header">
                    <h1 class="page-title">Manage Dependent Costs</h1>
                    <p class="page-subtitle">Configure additional costs for dependents (spouse, children) for each visa type</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Dependent Cost Rules</h2>
                        <button class="btn btn-primary" onclick="openDependentCostModal()">
                            <i class="fas fa-plus"></i>
                            Add Dependent Cost Rule
                        </button>
                    </div>
                    
                
                    <div class="visa-stats">
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="totalDependentRules">0</div>
                            <div class="visa-stat-label">Total Rules</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="activeDependentRules">0</div>
                            <div class="visa-stat-label">Active Rules</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="avgDependentCost">0</div>
                            <div class="visa-stat-label">Avg Cost per Dependent</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="maxDependents">0</div>
                            <div class="visa-stat-label">Max Dependents Allowed</div>
                        </div>
                    </div>

                
                    <div class="visa-search">
                        <input type="text" class="search-input" id="dependentCostSearch" placeholder="Search dependent cost rules..." onkeyup="filterDependentCosts()">
                    </div>

                    <div class="visa-filters">
                        <button class="filter-btn active" onclick="filterDependentCosts('all')">All</button>
                        <button class="filter-btn" onclick="filterDependentCosts('active')">Active Only</button>
                        <button class="filter-btn" onclick="filterDependentCosts('inactive')">Inactive Only</button>
                        <button class="filter-btn" onclick="sortDependentCosts('visaType')">Sort by Visa Type</button>
                        <button class="filter-btn" onclick="sortDependentCosts('cost')">Sort by Cost</button>
                        <button class="filter-btn" onclick="sortDependentCosts('dependentType')">Sort by Dependent Type</button>
                    </div>

                    <div id="dependentCostList">
                      
                    </div>
                </div>
            </section>

        
            <section id="chat-tracking" class="content-section">
                <div class="page-header">
                    <h1 class="page-title">Chat Tracking</h1>
                    <p class="page-subtitle">Monitor and analyze UK visa application chat interactions</p>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-number" id="totalChats">0</div>
                        <div class="stat-label">Total Conversations</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalQuestions">0</div>
                        <div class="stat-label">Total Questions</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="totalResponses">0</div>
                        <div class="stat-label">Total Responses</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-number" id="avgResponseTime">0s</div>
                        <div class="stat-label">Avg Response Time</div>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Chat Analytics</h2>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-primary" onclick="refreshChatData()">
                                <i class="fas fa-sync-alt"></i>
                                Refresh Data
                            </button>
                            <button class="btn btn-success" onclick="exportChatData()">
                                <i class="fas fa-download"></i>
                                Export CSV
                            </button>
                            <button class="btn btn-secondary" onclick="openChatFilters()">
                                <i class="fas fa-filter"></i>
                                Filters
                            </button>
                        </div>
                    </div>

                    
                    <div class="visa-filters" id="chatFilters" style="display: none;">
                        <button class="filter-btn active" onclick="filterChats('all')">All Chats</button>
                        <button class="filter-btn" onclick="filterChats('today')">Today</button>
                        <button class="filter-btn" onclick="filterChats('week')">This Week</button>
                        <button class="filter-btn" onclick="filterChats('month')">This Month</button>
                        <button class="filter-btn" onclick="filterChats('visa-related')">Visa Related</button>
                        <button class="filter-btn" onclick="filterChats('general')">General Questions</button>
                    </div>

                    
                    <div class="visa-search">
                        <input type="text" class="search-input" id="chatSearch" placeholder="Search chat conversations..." onkeyup="searchChats()">
                    </div>

                                                       
                    <div id="chatList">
                        <div style="text-align: center; padding: 3rem; color: var(--gray);">
                            <i class="fas fa-comments" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                            <h3>Loading chat data...</h3>
                            <p>Please wait while we fetch the latest chat interactions</p>
                        </div>
                    </div>

               
                    <div class="pagination" id="chatPagination" style="display: none;">
                        <button class="btn btn-secondary" onclick="previousChatPage()" id="prevChatBtn">
                            <i class="fas fa-chevron-left"></i> Previous
                        </button>
                        <span id="chatPageInfo" style="margin: 0 1rem; color: var(--gray);">Page 1 of 1</span>
                        <button class="btn btn-secondary" onclick="nextChatPage()" id="nextChatBtn">
                            Next <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                </div>

              
                <div class="modal" id="chatDetailsModal">
                    <div class="modal-content" style="max-width: 800px;">
                        <div class="modal-header">
                            <h3 class="modal-title">Chat Conversation Details</h3>
                            <button class="close-btn" onclick="closeChatDetailsModal()">&times;</button>
                        </div>
                        <div id="chatDetailsContent">
                            
                        </div>
                    </div>
                </div>
            </section>

            <!-- Dropdown Options Section -->
            <section id="dropdowns" class="content-section">
                <div class="page-header">
                    <h1 class="page-title">Manage Dropdown Options</h1>
                    <p class="page-subtitle">Configure dropdown options for application forms</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Dropdown Categories</h2>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-primary" onclick="openDropdownModal()">
                                <i class="fas fa-plus"></i>
                                Add Dropdown Option
                            </button>
                            <button class="btn btn-secondary" onclick="showQuickAddDropdownMenu()">
                                <i class="fas fa-bolt"></i>
                                Quick Add
                            </button>
                        </div>
                    </div>
                    
             
                    <div class="visa-stats">
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="totalDropdowns">0</div>
                            <div class="visa-stat-label">Total Categories</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="totalOptions">0</div>
                            <div class="visa-stat-label">Total Options</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="activeDropdowns">0</div>
                            <div class="visa-stat-label">Active Categories</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="mostUsed">0</div>
                            <div class="visa-stat-label">Most Used Category</div>
                        </div>
                    </div>

                    
                    <div class="visa-search">
                        <input type="text" class="search-input" id="dropdownSearch" placeholder="Search dropdown categories..." onkeyup="filterDropdowns()">
                    </div>

                    <div class="visa-filters">
                        <button class="filter-btn active" onclick="filterDropdowns('all', event)">All</button>
                        <button class="filter-btn" onclick="filterDropdowns('active', event)">Active Only</button>
                        <button class="filter-btn" onclick="filterDropdowns('inactive', event)">Inactive Only</button>
                        <button class="filter-btn" onclick="sortDropdowns('name', event)">Sort by Name</button>
                        <button class="filter-btn" onclick="sortDropdowns('options', event)">Sort by Options Count</button>
                        <button class="filter-btn" onclick="sortDropdowns('usage', event)">Sort by Usage</button>
                    </div>

                    <div id="dropdownList">
                        
                    </div>
                </div>
            </section>

      
            <section id="applicant-dropdowns" class="content-section">
                <div class="page-header">
                    <h1 class="page-title">Additional Applicant Dropdowns</h1>
                    <p class="page-subtitle">Manage dropdown options specifically for additional applicants</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Applicant-Specific Dropdown Categories</h2>
                        <div style="display: flex; gap: 1rem;">
                            <button class="btn btn-primary" onclick="openApplicantDropdownModal()">
                                <i class="fas fa-plus"></i>
                                Add Applicant Dropdown
                            </button>
                            <button class="btn btn-secondary" onclick="showQuickAddApplicantDropdownMenu()">
                                <i class="fas fa-bolt"></i>
                                Quick Add Templates
                            </button>
                        </div>
                    </div>
                    
                 
                    <div class="visa-stats">
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="totalApplicantDropdowns">0</div>
                            <div class="visa-stat-label">Applicant Categories</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="totalApplicantOptions">0</div>
                            <div class="visa-stat-label">Applicant Options</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="activeApplicantDropdowns">0</div>
                            <div class="visa-stat-label">Active Categories</div>
                        </div>
                        <div class="visa-stat">
                            <div class="visa-stat-number" id="applicantUsageCount">0</div>
                            <div class="visa-stat-label">Total Usage</div>
                        </div>
                    </div>

                  
                    <div class="visa-search">
                        <input type="text" class="search-input" id="applicantDropdownSearch" placeholder="Search applicant dropdown categories..." onkeyup="filterApplicantDropdowns()">
                    </div>

                    <div class="visa-filters">
                        <button class="filter-btn active" onclick="filterApplicantDropdowns('all', event)">All</button>
                        <button class="filter-btn" onclick="filterApplicantDropdowns('active', event)">Active Only</button>
                        <button class="filter-btn" onclick="filterApplicantDropdowns('inactive', event)">Inactive Only</button>
                        <button class="filter-btn" onclick="sortApplicantDropdowns('name', event)">Sort by Name</button>
                        <button class="filter-btn" onclick="sortApplicantDropdowns('options', event)">Sort by Options Count</button>
                        <button class="filter-btn" onclick="sortApplicantDropdowns('usage', event)">Sort by Usage</button>
                    </div>

                    <div id="applicantDropdownList">
                        
                    </div>
                </div>

              
                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">Dropdown Preview</h2>
                        <p class="card-subtitle">See how your dropdowns will appear in the application form</p>
                    </div>
                    <div class="preview-container">
                        <div class="preview-section">
                            <h3>Personal Information</h3>
                            <div class="form-group">
                                <select id="preview-nationality" class="form-input">
                                    <option value="" disabled selected>Select Nationality</option>
                                </select>
                                <label>Nationality</label>
                            </div>
                            <div class="form-group">
                                <select id="preview-gender" class="form-input">
                                    <option value="" disabled selected>Select Gender</option>
                                </select>
                                <label>Gender</label>
                            </div>
                            <div class="form-group">
                                <select id="preview-relationship" class="form-input">
                                    <option value="" disabled selected>Select Relationship</option>
                                </select>
                                <label>Relationship to Primary Applicant</label>
                            </div>
                        </div>
                        <div class="preview-section">
                            <h3>Employment Information</h3>
                            <div class="form-group">
                                <select id="preview-employmentStatus" class="form-input">
                                    <option value="" disabled selected>Select Employment Status</option>
                                </select>
                                <label>Employment Status</label>
                            </div>
                            <div class="form-group">
                                <select id="preview-incomeRange" class="form-input">
                                    <option value="" disabled selected>Select Income Range</option>
                                </select>
                                <label>Annual Income Range</label>
                            </div>
                        </div>
                        <div class="preview-section">
                            <h3>Travel Information</h3>
                            <div class="form-group">
                                <select id="preview-travelPurpose" class="form-input">
                                    <option value="" disabled selected>Select Travel Purpose</option>
                                </select>
                                <label>Purpose of Travel</label>
                            </div>
                            <div class="form-group">
                                <select id="preview-accommodationType" class="form-input">
                                    <option value="" disabled selected>Select Accommodation Type</option>
                                </select>
                                <label>Accommodation Type</label>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

          
            <section id="file-manager" class="content-section">
                <div class="page-header">
                    <h1 class="page-title">File Manager</h1>
                    <p class="page-subtitle">Upload, organize, and manage files and documents</p>
                </div>

               
                <div class="file-manager-toolbar">
                    <div class="toolbar-left">
                        <button class="btn btn-primary" onclick="openFileUploadModal()">
                            <i class="fas fa-upload"></i>
                            Upload Files
                        </button>
                        <button class="btn btn-secondary" onclick="createNewFolder()">
                            <i class="fas fa-folder-plus"></i>
                            New Folder
                        </button>
                        <button class="btn btn-secondary" onclick="refreshFileList()">
                            <i class="fas fa-sync-alt"></i>
                            Refresh
                        </button>
                    </div>
                    <div class="toolbar-right">
                        <div class="search-box">
                            <input type="text" id="fileSearch" placeholder="Search files..." class="search-input">
                            <i class="fas fa-search search-icon"></i>
                        </div>
                        <select id="fileViewMode" class="view-mode-select" onchange="changeFileViewMode()">
                            <option value="grid">Grid View</option>
                            <option value="list">List View</option>
                        </select>
                    </div>
                </div>

              
                <div class="file-breadcrumb">
                    <span class="breadcrumb-item" onclick="navigateToFolder('root')">
                        <i class="fas fa-home"></i>
                        Home
                    </span>
                    <span id="currentPath" class="breadcrumb-path">/</span>
                </div>

             
                <div class="file-manager-content">
                    <div class="file-sidebar">
                        <div class="sidebar-section">
                            <h3>Quick Access</h3>
                            <ul class="quick-access-list">
                                <li onclick="navigateToFolder('documents')">
                                    <i class="fas fa-file-alt"></i>
                                    Documents
                                </li>
                                <li onclick="navigateToFolder('images')">
                                    <i class="fas fa-image"></i>
                                    Images
                                </li>
                                <li onclick="navigateToFolder('templates')">
                                    <i class="fas fa-file-code"></i>
                                    Templates
                                </li>
                                <li onclick="navigateToFolder('uploads')">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    Uploads
                                </li>
                            </ul>
                        </div>
                        <div class="sidebar-section">
                            <h3>File Types</h3>
                            <div class="file-type-filters">
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="document" checked onchange="filterByType()">
                                    <span>Documents</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="image" checked onchange="filterByType()">
                                    <span>Images</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="video" checked onchange="filterByType()">
                                    <span>Videos</span>
                                </label>
                                <label class="filter-checkbox">
                                    <input type="checkbox" value="archive" checked onchange="filterByType()">
                                    <span>Archives</span>
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="file-main-content">
                        <div id="fileList" class="file-grid">
                           
                        </div>
                    </div>
                </div>
            </section>

        
            <section id="settings" class="content-section">
                <div class="page-header">
                    <h1 class="page-title">Settings</h1>
                    <p class="page-subtitle">Configure system settings and preferences</p>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h2 class="card-title">General Settings</h2>
                    </div>
                    <form id="settingsForm">
                        <div class="form-group">
                            <label class="form-label">Default Credits</label>
                            <input type="number" class="form-input" id="defaultCredits" value="10" min="1" max="100">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Company Name</label>
                            <input type="text" class="form-input" id="companyName" value="ICS LEGAL">
                        </div>
                        <div class="form-group">
                            <label class="form-label">Contact Email</label>
                            <input type="email" class="form-input" id="contactEmail" value="info@ukvisaservices.com">
                        </div>
                        <button type="submit" class="btn btn-primary">Save Settings</button>
                    </form>
                </div>
            </section>

         
            <section id="faqs" class="content-section">
                <div class="page-header">
                    <h1 class="page-title">FAQs</h1>
                    <p class="page-subtitle">Add, edit, and delete Frequently Asked Questions</p>
                </div>

                <div class="card">
                    <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
                        <h2 class="card-title">FAQ List</h2>
                        <button class="btn btn-primary" onclick="openFaqModal()">
                            <i class="fas fa-plus"></i>
                            Add FAQ
                        </button>
                    </div>
                    <div style="padding:1rem;">
                        <div class="visa-search" style="margin-bottom:1rem;">
                            <input type="text" class="search-input" id="faqSearch" placeholder="Search FAQs..." onkeyup="renderFaqs()">
                        </div>
                        <div id="faqList">
                            
                        </div>
                    </div>
                </div>
            </section>


            <div id="faqModal" class="modal">
                <div class="modal-content" style="max-width:800px; width:100%;">
                    <div class="modal-header">
                        <h3 class="modal-title" id="faqModalTitle">
                            <i class="fas fa-question-circle"></i>
                            Add FAQ
                        </h3>
                        <button class="modal-close" onclick="closeFaqModal()">&times;</button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="faqId">
                        <div class="form-group">
                            <label for="faqQuestion">
                                <i class="fas fa-question"></i>
                                Question *
                            </label>
                            <input type="text" id="faqQuestion" class="form-control" placeholder="Enter a clear, specific question..." maxlength="200">
                            <small class="form-text" style="color: var(--gray); margin-top: 0.25rem;">
                                <span id="questionCount">0</span>/200 characters
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="faqAnswer">
                                <i class="fas fa-comment-alt"></i>
                                Answer *
                            </label>
                            <div style="display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:0.5rem;">
                                <button type="button" class="btn btn-secondary btn-sm" onclick="applyFaqFormatting('bold')" title="Bold"><i class="fas fa-bold"></i></button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="applyFaqFormatting('italic')" title="Italic"><i class="fas fa-italic"></i></button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="applyFaqFormatting('ul')" title="Bullet list"><i class="fas fa-list-ul"></i></button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="applyFaqFormatting('ol')" title="Numbered list"><i class="fas fa-list-ol"></i></button>
                                <button type="button" class="btn btn-secondary btn-sm" onclick="applyFaqFormatting('link')" title="Insert link"><i class="fas fa-link"></i></button>
                            </div>
                            <textarea id="faqAnswer" class="form-control" rows="8" placeholder="Tip: you can use **bold**, *italic*, lists (- or 1.), and [links](https://example.com)" maxlength="1000"></textarea>
                            <div id="faqAnswerPreview" style="margin-top:0.5rem; padding:0.75rem; border:1px solid var(--light-gray); background: var(--off-white); border-radius:6px; font-size:0.95rem; line-height:1.6; color: var(--dark);">
                                <div style="color: var(--gray);">Live preview will appear here</div>
                            </div>
                            <small class="form-text" style="color: var(--gray); margin-top: 0.25rem;">
                                <span id="answerCount">0</span>/1000 characters
                            </small>
                        </div>
                        <div class="form-group">
                            <label for="faqCategory">
                                <i class="fas fa-tags"></i>
                                Category
                            </label>
                            <select id="faqCategory" class="form-control">
                                <option value="general">General</option>
                                <option value="visa-types">Visa Types</option>
                                <option value="application">Application Process</option>
                                <option value="documents">Documents</option>
                                <option value="payment">Payment</option>
                                <option value="timeline">Timeline</option>
                                <option value="support">Support</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>
                                <input type="checkbox" id="faqFeatured" style="margin-right: 0.5rem;">
                                <i class="fas fa-star"></i>
                                Featured FAQ (shows first)
                            </label>
                        </div>
                    </div>
                    <div class="modal-footer" style="display:flex; justify-content:space-between; align-items:center;">
                        <div style="color: var(--gray); font-size: 0.9rem;">
                            <i class="fas fa-info-circle"></i>
                            Fields marked with * are required
                        </div>
                        <div style="display:flex; gap:0.5rem;">
                            <button class="btn btn-secondary" onclick="closeFaqModal()">
                                <i class="fas fa-times"></i>
                                Cancel
                            </button>
                            <button class="btn btn-primary" onclick="saveFaq()" id="saveFaqBtn">
                                <i class="fas fa-save"></i>
                                Save FAQ
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>


    <div class="file-upload-modal" id="fileUploadModal">
        <div class="file-upload-content">
            <div class="modal-header">
                <h3 class="modal-title">Upload Files</h3>
                <button class="close-btn" onclick="closeFileUploadModal()">&times;</button>
            </div>
            
            <div class="file-upload-area" id="fileUploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="file-upload-icon">
                    <i class="fas fa-cloud-upload-alt"></i>
                </div>
                <div class="file-upload-text">Click to upload or drag files here</div>
                <div class="file-upload-hint">Supports: PDF, DOC, DOCX, JPG, PNG, ZIP, RAR (Max 50MB each)</div>
            </div>
            
            <input type="file" id="fileInput" multiple accept=".pdf,.doc,.docx,.jpg,.jpeg,.png,.gif,.zip,.rar,.txt,.xlsx,.xls" style="display: none;">
            
            <div class="file-preview" id="filePreview"></div>
            
            <div class="form-group">
                <label class="form-label">Upload to Folder</label>
                <select class="form-input" id="uploadFolder">
                    <option value="root">Root Directory</option>
                    <option value="documents">Documents</option>
                    <option value="images">Images</option>
                    <option value="templates">Templates</option>
                    <option value="uploads">Uploads</option>
                </select>
            </div>
            
            <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                <button type="button" class="btn btn-primary" onclick="uploadFiles()">
                    <i class="fas fa-upload"></i>
                    Upload Files
                </button>
                <button type="button" class="btn btn-secondary" onclick="closeFileUploadModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Visa Type Modal -->
    <div class="modal" id="visaModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="visaModalTitle">Add Visa Type</h3>
                <button class="close-btn" onclick="closeVisaModal()">&times;</button>
            </div>
            <form id="visaForm">
                <div class="form-group">
                    <label class="form-label">Visa Name *</label>
                    <input type="text" class="form-input" id="visaName" required placeholder="e.g., Business Visa">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <div id="visaDescriptionEditor"></div>
                    <textarea class="form-input form-textarea" id="visaDescription" placeholder="Brief description of the visa type and requirements" style="display: none;"></textarea>
                    <small style="color: var(--gray); font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                        <i class="fas fa-info-circle"></i> This field supports rich text formatting including bold, italic, lists, links, and more.
                    </small>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Processing Time (days) *</label>
                        <input type="number" class="form-input" id="processingTime" min="1" max="365" required placeholder="e.g., 15">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Base Price () *</label>
                        <input type="number" class="form-input" id="basePrice" min="0" step="0.01" required placeholder="e.g., 299.00">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Visa Category</label>
                    <select class="form-input" id="visaCategory">
                        <option value="business">Business</option>
                        <option value="family">Family</option>
                        <option value="student">Student</option>
                        <option value="work">Work</option>
                        <option value="tourism">Tourism</option>
                        <option value="other">Other</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Requirements (one per line)</label>
                    <textarea class="form-input form-textarea" id="visaRequirements" placeholder="List key requirements for this visa type&#10;e.g., Valid passport&#10;Proof of funds&#10;Employment letter"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Active Status</label>
                    <select class="form-input" id="visaActive">
                        <option value="true">Active - Available for applications</option>
                        <option value="false">Inactive - Temporarily unavailable</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Save Visa Type</button>
                    <button type="button" class="btn btn-secondary" onclick="closeVisaModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <div class="modal" id="dependentCostModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="dependentCostModalTitle">Add Dependent Cost Rule</h3>
                <button class="close-btn" onclick="closeDependentCostModal()">&times;</button>
            </div>
            <form id="dependentCostForm">
                <div class="form-group">
                    <label class="form-label">Visa Type *</label>
                    <select class="form-input" id="dependentVisaType" required>
                        <option value="">Select visa type</option>
                    </select>
                </div>
                <div class="form-group">
                    <label class="form-label">Dependent Type *</label>
                    <select class="form-input" id="dependentType" required>
                        <option value="">Select dependent type</option>
                        <option value="spouse">Spouse/Partner</option>
                        <option value="child">Child (Under 18)</option>
                        <option value="adult-child">Adult Child (18+)</option>
                        <option value="parent">Parent</option>
                        <option value="other">Other Family Member</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Additional Cost () *</label>
                        <input type="number" class="form-input" id="dependentCost" min="0" step="0.01" required placeholder="e.g., 150.00">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Maximum Dependents</label>
                        <input type="number" class="form-input" id="maxDependents" min="0" max="10" placeholder="e.g., 3 (0 = unlimited)">
                    </div>
                </div>
                <div class="form-group">
                    <label class="form-label">Processing Time (days)</label>
                    <input type="number" class="form-input" id="dependentProcessingTime" min="0" max="365" placeholder="Additional processing time for dependents">
                </div>
                <div class="form-group">
                    <label class="form-label">Requirements (one per line)</label>
                    <textarea class="form-input form-textarea" id="dependentRequirements" placeholder="Additional requirements for dependents&#10;e.g., Marriage certificate&#10;Birth certificates&#10;Proof of relationship"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Notes</label>
                    <textarea class="form-input form-textarea" id="dependentNotes" placeholder="Additional notes or special conditions"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Active Status</label>
                    <select class="form-input" id="dependentActive">
                        <option value="true">Active - Available for applications</option>
                        <option value="false">Inactive - Temporarily unavailable</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Save Dependent Cost Rule</button>
                    <button type="button" class="btn btn-secondary" onclick="closeDependentCostModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

 
    <div class="modal" id="packageModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="packageModalTitle">Add Package</h3>
                <button class="close-btn" onclick="closePackageModal()">&times;</button>
            </div>
            <form id="packageForm">
                <div class="form-group">
                    <label class="form-label">Package Name</label>
                    <input type="text" class="form-input" id="packageName" required placeholder="e.g., Basic Package">
                </div>
                <div class="form-group">
                    <label class="form-label">Price ()</label>
                    <input type="number" class="form-input" id="packagePrice" min="0" step="0.01" required placeholder="e.g., 299.00">
                </div>
                <div class="form-group">
                    <label class="form-label">Features (one per line)</label>
                    <textarea class="form-input form-textarea" id="packageFeatures" placeholder="Visa application guidance&#10;Document checklist&#10;Email support"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Active</label>
                    <select class="form-input" id="packageActive">
                        <option value="true">Yes</option>
                        <option value="false">No</option>
                    </select>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Save Package</button>
                    <button type="button" class="btn btn-secondary" onclick="closePackageModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    
    <div class="modal" id="dropdownModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="dropdownModalTitle">Add Dropdown Category</h3>
                <button class="close-btn" onclick="closeDropdownModal()">&times;</button>
            </div>
            <form id="dropdownForm">
                <div class="form-group">
                    <label class="form-label">Category Name *</label>
                    <input type="text" class="form-input" id="dropdownName" required placeholder="e.g., Nationality">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input form-textarea" id="dropdownDescription" placeholder="Brief description of this dropdown category"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Options (one per line) *</label>
                    <textarea class="form-input form-textarea" id="dropdownOptions" required placeholder="Option 1&#10;Option 2&#10;Option 3"></textarea>
                    <small class="form-help">Enter each option on a new line. You can also use format: value|text (e.g., US|United States)</small>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Default Value</label>
                        <input type="text" class="form-input" id="dropdownDefault" placeholder="Default selected option">
                    </div>
                    <div class="form-group">
                        <label class="form-label">Sort Order</label>
                        <select class="form-input" id="dropdownSortOrder">
                            <option value="alphabetical">Alphabetical</option>
                            <option value="custom">Custom Order</option>
                            <option value="usage">By Usage</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label class="form-label">Required Field</label>
                        <select class="form-input" id="dropdownRequired">
                            <option value="true">Yes - User must select an option</option>
                            <option value="false">No - Optional field</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Active Status</label>
                        <select class="form-input" id="dropdownActive">
                            <option value="true">Active - Available for use</option>
                            <option value="false">Inactive - Temporarily disabled</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Save Dropdown Category</button>
                    <button type="button" class="btn btn-secondary" onclick="closeDropdownModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>


    <div class="modal" id="applicantDropdownModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title" id="applicantDropdownModalTitle">Add Applicant Dropdown Category</h3>
                <button class="close-btn" onclick="closeApplicantDropdownModal()">&times;</button>
            </div>
            <form id="applicantDropdownForm">
                <div class="form-group">
                    <label class="form-label">Category Name *</label>
                    <input type="text" class="form-input" id="applicantDropdownName" required placeholder="e.g., Relationship Status">
                </div>
                <div class="form-group">
                    <label class="form-label">Description</label>
                    <textarea class="form-input form-textarea" id="applicantDropdownDescription" placeholder="Brief description of this dropdown category"></textarea>
                </div>
                <div class="form-group">
                    <label class="form-label">Options (one per line) *</label>
                    <textarea class="form-input form-textarea" id="applicantDropdownOptions" required placeholder="Single&#10;Married&#10;Divorced&#10;Widowed" style="min-height: 120px;"></textarea>
                    <small style="color: var(--gray); font-size: 0.875rem; margin-top: 0.5rem; display: block;">
                        <i class="fas fa-info-circle"></i> Enter each option on a new line
                    </small>
                </div>
                <div class="form-row" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
                    <div class="form-group">
                        <label class="form-label">Sort Order</label>
                        <select class="form-input" id="applicantDropdownSortOrder">
                            <option value="alphabetical">Alphabetical</option>
                            <option value="custom">Custom Order</option>
                            <option value="usage">Most Used First</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Status</label>
                        <select class="form-input" id="applicantDropdownActive">
                            <option value="true">Active</option>
                            <option value="false">Inactive</option>
                        </select>
                    </div>
                </div>
                <div style="display: flex; gap: 1rem; margin-top: 1.5rem;">
                    <button type="submit" class="btn btn-primary">Save Applicant Dropdown Category</button>
                    <button type="button" class="btn btn-secondary" onclick="closeApplicantDropdownModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        
        let visaTypes = JSON.parse(localStorage.getItem('visaTypes')) || [
            { id: 1, name: 'Business Visa', description: 'For business activities and meetings', processingTime: 15, basePrice: 299, active: true },
            { id: 2, name: 'Family Visa', description: 'For family reunification', processingTime: 60, basePrice: 399, active: true },
            { id: 3, name: 'General Visitor Visa', description: 'For tourism and general visits', processingTime: 15, basePrice: 199, active: true },
            { id: 4, name: 'Graduate Visa', description: 'For recent graduates', processingTime: 30, basePrice: 349, active: true },
            { id: 5, name: 'Health and Care Worker Visa', description: 'For healthcare professionals', processingTime: 45, basePrice: 449, active: true },
            { id: 6, name: 'High Potential Individual Visa', description: 'For high-skilled individuals', processingTime: 30, basePrice: 599, active: true },
            { id: 7, name: 'Innovator Visa', description: 'For business innovators', processingTime: 60, basePrice: 799, active: true },
            { id: 8, name: 'Investor Visa', description: 'For investors', processingTime: 90, basePrice: 999, active: true },
            { id: 9, name: 'Marriage Visitor Visa', description: 'For marriage ceremonies', processingTime: 30, basePrice: 299, active: true },
            { id: 10, name: 'Parent of a Child Student Visa', description: 'For parents of student children', processingTime: 45, basePrice: 399, active: true },
            { id: 11, name: 'Partner Visa', description: 'For partners and spouses', processingTime: 60, basePrice: 449, active: true },
            { id: 12, name: 'Skilled Worker Visa', description: 'For skilled workers', processingTime: 30, basePrice: 499, active: true },
            { id: 13, name: 'Student Visa', description: 'For students', processingTime: 15, basePrice: 249, active: true },
            { id: 14, name: 'Temporary Worker Visa', description: 'For temporary work', processingTime: 20, basePrice: 349, active: true },
            { id: 15, name: 'Youth Mobility Scheme Visa', description: 'For young people', processingTime: 15, basePrice: 299, active: true }
        ];

        let packages = JSON.parse(localStorage.getItem('packages')) || [
            { id: 1, name: 'Basic Package', price: 299, features: ['Visa application guidance', 'Document checklist', 'Email support', 'Basic review service'], active: true },
            { id: 2, name: 'Premium Package', price: 599, features: ['Everything in Basic', 'Priority processing', 'Phone support', 'Full document review', 'Application submission assistance'], active: true },
            { id: 3, name: 'Premium Plus Package', price: 999, features: ['Everything in Premium', 'Dedicated case manager', 'Interview preparation', 'Appeal support if needed', '24/7 emergency support'], active: true }
        ];

        let settings = JSON.parse(localStorage.getItem('settings')) || {
            defaultCredits: 10,
            companyName: 'ICS LEGAL',
            contactEmail: 'info@icslegal.com'
        };

        let dependentCosts = JSON.parse(localStorage.getItem('dependentCosts')) || [
            { id: 1, visaTypeId: 1, visaTypeName: 'Business Visa', dependentType: 'spouse', dependentTypeLabel: 'Spouse/Partner', additionalCost: 150, maxDependents: 2, processingTime: 5, requirements: ['Marriage certificate', 'Proof of relationship'], notes: 'Spouse can apply together with main applicant', active: true },
            { id: 2, visaTypeId: 1, visaTypeName: 'Business Visa', dependentType: 'child', dependentTypeLabel: 'Child (Under 18)', additionalCost: 100, maxDependents: 3, processingTime: 3, requirements: ['Birth certificate', 'Proof of relationship'], notes: 'Children under 18 can be included', active: true },
            { id: 3, visaTypeId: 2, visaTypeName: 'Family Visa', dependentType: 'child', dependentTypeLabel: 'Child (Under 18)', additionalCost: 200, maxDependents: 5, processingTime: 10, requirements: ['Birth certificate', 'Proof of relationship', 'Financial support evidence'], notes: 'Family visas allow more dependents', active: true },
            { id: 4, visaTypeId: 12, visaTypeName: 'Skilled Worker Visa', dependentType: 'spouse', dependentTypeLabel: 'Spouse/Partner', additionalCost: 200, maxDependents: 2, processingTime: 7, requirements: ['Marriage certificate', 'Proof of relationship', 'Financial evidence'], notes: 'Spouse can work in the UK', active: true },
            { id: 5, visaTypeId: 12, visaTypeName: 'Skilled Worker Visa', dependentType: 'child', dependentTypeLabel: 'Child (Under 18)', additionalCost: 150, maxDependents: 3, processingTime: 5, requirements: ['Birth certificate', 'Proof of relationship'], notes: 'Children can study in the UK', active: true }
        ];

        let dropdownOptions = JSON.parse(localStorage.getItem('dropdownOptions')) || [
            { 
                id: 1, 
                name: 'Nationality', 
                description: 'Country of nationality for visa applications',
                options: [
                    { value: 'US', text: 'United States', sortOrder: 1, active: true },
                    { value: 'UK', text: 'United Kingdom', sortOrder: 2, active: true },
                    { value: 'CA', text: 'Canada', sortOrder: 3, active: true },
                    { value: 'AU', text: 'Australia', sortOrder: 4, active: true },
                    { value: 'FR', text: 'France', sortOrder: 5, active: true },
                    { value: 'DE', text: 'Germany', sortOrder: 6, active: true },
                    { value: 'IT', text: 'Italy', sortOrder: 7, active: true },
                    { value: 'ES', text: 'Spain', sortOrder: 8, active: true },
                    { value: 'JP', text: 'Japan', sortOrder: 9, active: true },
                    { value: 'CN', text: 'China', sortOrder: 10, active: true },
                    { value: 'IN', text: 'India', sortOrder: 11, active: true }
                ],
                defaultValue: '',
                sortOrder: 'alphabetical',
                required: true,
                active: true,
                usageCount: 0
            },
            { 
                id: 2, 
                name: 'Gender', 
                description: 'Gender identification options',
                options: [
                    { value: 'male', text: 'Male', sortOrder: 1, active: true },
                    { value: 'female', text: 'Female', sortOrder: 2, active: true },
                    { value: 'other', text: 'Other', sortOrder: 3, active: true },
                    { value: 'prefer-not', text: 'Prefer not to say', sortOrder: 4, active: true }
                ],
                defaultValue: '',
                sortOrder: 'custom',
                required: true,
                active: true,
                usageCount: 0
            },
            { 
                id: 3, 
                name: 'Employment Status', 
                description: 'Current employment status options',
                options: [
                    { value: 'full-time', text: 'Full-Time', sortOrder: 1, active: true },
                    { value: 'part-time', text: 'Part-Time', sortOrder: 2, active: true },
                    { value: 'contract', text: 'Contract', sortOrder: 3, active: true },
                    { value: 'self-employed', text: 'Self-Employed', sortOrder: 4, active: true },
                    { value: 'unemployed', text: 'Unemployed', sortOrder: 5, active: true },
                    { value: 'student', text: 'Student', sortOrder: 6, active: true },
                    { value: 'retired', text: 'Retired', sortOrder: 7, active: true }
                ],
                defaultValue: '',
                sortOrder: 'custom',
                required: true,
                active: true,
                usageCount: 0
            },
            { 
                id: 4, 
                name: 'Travel Purpose', 
                description: 'Purpose of travel options',
                options: [
                    { value: 'tourism', text: 'Tourism', sortOrder: 1, active: true },
                    { value: 'business', text: 'Business', sortOrder: 2, active: true },
                    { value: 'education', text: 'Education', sortOrder: 3, active: true },
                    { value: 'medical', text: 'Medical', sortOrder: 4, active: true },
                    { value: 'family', text: 'Family Visit', sortOrder: 5, active: true },
                    { value: 'other', text: 'Other', sortOrder: 6, active: true }
                ],
                defaultValue: '',
                sortOrder: 'custom',
                required: true,
                active: true,
                usageCount: 0
            },
            { 
                id: 5, 
                name: 'Document Type', 
                description: 'Document type categories for uploads',
                options: [
                    { value: 'passport', text: 'Passport', sortOrder: 1, active: true },
                    { value: 'id', text: 'Government ID', sortOrder: 2, active: true },
                    { value: 'photo', text: 'Passport Photo', sortOrder: 3, active: true },
                    { value: 'financial', text: 'Financial Documents', sortOrder: 4, active: true },
                    { value: 'employment', text: 'Employment Letter', sortOrder: 5, active: true },
                    { value: 'other', text: 'Other', sortOrder: 6, active: true }
                ],
                defaultValue: '',
                sortOrder: 'custom',
                required: true,
                active: true,
                usageCount: 0
            },
            { 
                id: 6, 
                name: 'Relationship Type', 
                description: 'Relationship types for additional applicants',
                options: [
                    { value: 'spouse', text: 'Spouse', sortOrder: 1, active: true },
                    { value: 'child', text: 'Child', sortOrder: 2, active: true },
                    { value: 'parent', text: 'Parent', sortOrder: 3, active: true },
                    { value: 'sibling', text: 'Sibling', sortOrder: 4, active: true },
                    { value: 'other-family', text: 'Other Family Member', sortOrder: 5, active: true },
                    { value: 'friend', text: 'Friend', sortOrder: 6, active: true },
                    { value: 'colleague', text: 'Colleague', sortOrder: 7, active: true },
                    { value: 'other', text: 'Other', sortOrder: 8, active: true }
                ],
                defaultValue: '',
                sortOrder: 'custom',
                required: true,
                active: true,
                usageCount: 0
            }
        ];

        // FAQs storage
        let faqs = JSON.parse(localStorage.getItem('faqs')) || [
            { id: 1, question: 'How long does visa processing take?', answer: 'Processing times vary by visa type. See each visa for details.', category: 'general', featured: true },
            { id: 2, question: 'Can I include dependents?', answer: 'Yes, you can include spouse/partner and children where applicable.', category: 'application', featured: false }
        ];

        function saveFaqsToStorage() {
            localStorage.setItem('faqs', JSON.stringify(faqs));
        }

        function navigateToSection(sectionId) {
            const sections = document.querySelectorAll('.content-section');
            sections.forEach(s => {
                s.classList.remove('active');
                s.style.display = '';
            });
            const target = document.getElementById(sectionId);
            if (target) {
                target.classList.add('active');
            }
            const navLinks = document.querySelectorAll('.nav-link');
            navLinks.forEach(l => l.classList.remove('active'));
            const match = Array.from(navLinks).find(l => l.getAttribute('data-section') === sectionId);
            if (match) match.classList.add('active');
            if (sectionId === 'faqs') {
                renderFaqs();
            }
        }

        function openFaqModal(faqId = null) {
            const modal = document.getElementById('faqModal');
            document.getElementById('faqId').value = faqId ? String(faqId) : '';
            const isEdit = !!faqId;
            document.getElementById('faqModalTitle').innerHTML = `<i class="fas fa-question-circle"></i> ${isEdit ? 'Edit FAQ' : 'Add FAQ'}`;
            
            const questionInput = document.getElementById('faqQuestion');
            const answerInput = document.getElementById('faqAnswer');
            const categorySelect = document.getElementById('faqCategory');
            const featuredCheckbox = document.getElementById('faqFeatured');
            const preview = document.getElementById('faqAnswerPreview');
            
            // Improve accessibility and UX
            if (questionInput) questionInput.setAttribute('aria-label', 'FAQ question');
            if (answerInput) answerInput.setAttribute('aria-label', 'FAQ answer');
            
            if (isEdit) {
                const existing = faqs.find(f => f.id === faqId);
                if (existing) {
                    questionInput.value = existing.question || '';
                    answerInput.value = existing.answer || '';
                    categorySelect.value = existing.category || 'general';
                    featuredCheckbox.checked = existing.featured || false;
                }
            } else {
                questionInput.value = '';
                answerInput.value = '';
                categorySelect.value = 'general';
                featuredCheckbox.checked = false;
            }
            
          
            updateCharacterCounts();
            
      
            questionInput.addEventListener('input', () => {
                updateCharacterCounts();
                saveFaqDraft();
            });
            answerInput.addEventListener('input', () => {
                updateCharacterCounts();
                renderFaqPreview(answerInput.value, preview);
                saveFaqDraft();
            });

            // Restore draft if available (only for Add)
            if (!isEdit) {
                const draft = loadFaqDraft();
                if (draft) {
                    questionInput.value = draft.question || '';
                    answerInput.value = draft.answer || '';
                    categorySelect.value = draft.category || 'general';
                    featuredCheckbox.checked = !!draft.featured;
                    updateCharacterCounts();
                }
            }

            // Initial preview
            renderFaqPreview(answerInput.value, preview);
            
            modal.classList.add('active');
            questionInput.focus();

            // Ensure textarea auto-resize when opening
            enhanceTextAreas();

            // Keyboard shortcuts: Ctrl/Cmd+Enter to save, Esc to close
            window._faqKeyHandler = function(e) {
                if ((e.ctrlKey || e.metaKey) && e.key === 'Enter') {
                    e.preventDefault();
                    saveFaq();
                } else if (e.key === 'Escape') {
                    e.preventDefault();
                    closeFaqModal();
                }
            };
            document.addEventListener('keydown', window._faqKeyHandler);
        }
        
        function updateCharacterCounts() {
            const questionInput = document.getElementById('faqQuestion');
            const answerInput = document.getElementById('faqAnswer');
            const questionCount = document.getElementById('questionCount');
            const answerCount = document.getElementById('answerCount');
            
            if (questionInput && questionCount) {
                const count = questionInput.value.length;
                questionCount.textContent = count;
                questionCount.style.color = count > 200 ? 'var(--error)' : 'var(--gray)';
                const remainingQ = Math.max(0, (questionInput.maxLength || 200) - count);
                if (questionCount.parentElement) questionCount.parentElement.title = `${remainingQ} characters remaining`;
            }
            
            if (answerInput && answerCount) {
                const count = answerInput.value.length;
                answerCount.textContent = count;
                answerCount.style.color = count > 1000 ? 'var(--error)' : 'var(--gray)';
                const remainingA = Math.max(0, (answerInput.maxLength || 1000) - count);
                if (answerCount.parentElement) answerCount.parentElement.title = `${remainingA} characters remaining`;
            }
        }

        function closeFaqModal() {
            const modal = document.getElementById('faqModal');
            modal.classList.remove('active');
            if (window._faqKeyHandler) {
                document.removeEventListener('keydown', window._faqKeyHandler);
                window._faqKeyHandler = null;
            }
        }

        function saveFaq() {
            const idStr = document.getElementById('faqId').value;
            const question = (document.getElementById('faqQuestion').value || '').trim();
            const answer = (document.getElementById('faqAnswer').value || '').trim();
            const category = document.getElementById('faqCategory').value;
            const featured = document.getElementById('faqFeatured').checked;
            
        
            if (!question || !answer) {
                alert('Please provide both question and answer.');
                return;
            }
            
            if (question.length > 200) {
                alert('Question is too long. Maximum 200 characters allowed.');
                return;
            }
            
            if (answer.length > 1000) {
                alert('Answer is too long. Maximum 1000 characters allowed.');
                return;
            }
            
       
            if (idStr) {
                const id = parseInt(idStr, 10);
                const idx = faqs.findIndex(f => f.id === id);
                if (idx !== -1) {
                    faqs[idx].question = question;
                    faqs[idx].answer = answer;
                    faqs[idx].category = category;
                    faqs[idx].featured = featured;
                    faqs[idx].updatedAt = new Date().toISOString();
                }
            } else {
                const newId = (faqs.length ? Math.max(...faqs.map(f => f.id)) : 0) + 1;
                faqs.push({ 
                    id: newId, 
                    question, 
                    answer, 
                    category, 
                    featured,
                    createdAt: new Date().toISOString()
                });
            }
            
            saveFaqsToStorage();
            closeFaqModal();
            renderFaqs();
            
         
            showNotification('FAQ saved successfully!', 'success');

            // Clear draft after successful save
            clearFaqDraft();
        }

        function deleteFaq(id) {
            if (!confirm('Delete this FAQ?')) return;
            faqs = faqs.filter(f => f.id !== id);
            saveFaqsToStorage();
            renderFaqs();
        }

        function renderFaqs() {
            const container = document.getElementById('faqList');
            if (!container) return;
            const q = (document.getElementById('faqSearch')?.value || '').toLowerCase();
            const items = faqs.filter(f =>
                f.question.toLowerCase().includes(q) || 
                f.answer.toLowerCase().includes(q) ||
                (f.category && f.category.toLowerCase().includes(q))
            );
            
          
            items.sort((a, b) => {
                if (a.featured && !b.featured) return -1;
                if (!a.featured && b.featured) return 1;
                if (a.category !== b.category) return a.category.localeCompare(b.category);
                return a.question.localeCompare(b.question);
            });
            
            if (!items.length) {
                container.innerHTML = '<p style="color: var(--gray); text-align: center; padding: 2rem;"><i class="fas fa-search"></i> No FAQs found.</p>';
                return;
            }
            
            const html = items.map(f => {
                const categoryLabel = f.category ? f.category.replace('-', ' ').replace(/\b\w/g, l => l.toUpperCase()) : 'General';
                const featuredBadge = f.featured ? '<span class="badge" style="background: var(--warning); color: var(--light); margin-left: 0.5rem;"><i class="fas fa-star"></i> Featured</span>' : '';
                const categoryBadge = `<span class="badge" style="background: var(--primary); color: var(--light); margin-right: 0.5rem;">${categoryLabel}</span>`;
                
                return `
                    <div class="card" style="margin-bottom:0.75rem; ${f.featured ? 'border-left: 4px solid var(--warning);' : ''}">
                        <div class="card-header" style="display:flex; justify-content:space-between; align-items:center;">
                            <div style="flex: 1;">
                                <h3 class="card-title" style="font-size:1rem; margin: 0; display: flex; align-items: center;">
                                    ${categoryBadge}
                                    ${escapeHtml(f.question)}
                                    ${featuredBadge}
                                </h3>
                            </div>
                            <div class="visa-actions">
                                <button class="btn btn-secondary btn-sm" onclick="openFaqModal(${f.id})" title="Edit FAQ">
                                    <i class="fas fa-edit"></i> Edit
                                </button>
                                <button class="btn btn-danger btn-sm" onclick="deleteFaq(${f.id})" title="Delete FAQ">
                                    <i class="fas fa-trash"></i> Delete
                                </button>
                            </div>
                        </div>
                        <div style="padding:1rem; color: var(--dark); white-space:pre-wrap; line-height: 1.6;">
                            ${escapeHtml(f.answer)}
                        </div>
                        <div style="padding: 0.5rem 1rem; background: var(--lighter-gray); font-size: 0.8rem; color: var(--gray); border-top: 1px solid var(--light-gray);">
                            <i class="fas fa-tag"></i> ${categoryLabel}
                            ${f.createdAt ? `  <i class="fas fa-calendar"></i> Created: ${new Date(f.createdAt).toLocaleDateString()}` : ''}
                            ${f.updatedAt ? `  <i class="fas fa-edit"></i> Updated: ${new Date(f.updatedAt).toLocaleDateString()}` : ''}
                        </div>
                    </div>
                `;
            }).join('');
            container.innerHTML = html;
        }

        // --- FAQ editor helpers ---
        function applyFaqFormatting(action) {
            const textarea = document.getElementById('faqAnswer');
            if (!textarea) return;
            const start = textarea.selectionStart;
            const end = textarea.selectionEnd;
            const text = textarea.value;
            const selected = text.slice(start, end) || '';
            let before = text.slice(0, start);
            let after = text.slice(end);
            let inserted = '';

            if (action === 'bold') {
                inserted = `**${selected || 'bold text'}**`;
            } else if (action === 'italic') {
                inserted = `*${selected || 'italic text'}*`;
            } else if (action === 'ul') {
                const lines = (selected || 'item one\nitem two').split(/\r?\n/).map(l => l ? `- ${l}` : '- item');
                inserted = lines.join('\n');
            } else if (action === 'ol') {
                const lines = (selected || 'first\nsecond').split(/\r?\n/).map((l, i) => `${i + 1}. ${l || 'item'}`);
                inserted = lines.join('\n');
            } else if (action === 'link') {
                const url = prompt('Enter URL', 'https://');
                if (url) {
                    inserted = `[${selected || 'link text'}](${url})`;
                } else {
                    return;
                }
            }

            textarea.value = before + inserted + after;
            const newCaret = (before + inserted).length;
            textarea.setSelectionRange(newCaret, newCaret);
            textarea.dispatchEvent(new Event('input'));
            textarea.focus();
        }

        function renderFaqPreview(markdownText, container) {
            if (!container) return;
            const html = simpleMarkdownToHtml(markdownText || '');
            container.innerHTML = html || '<div style="color: var(--gray);">Live preview will appear here</div>';
        }

        function simpleMarkdownToHtml(md) {
            let html = md;
            // Escape HTML first
            html = html
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/\"/g, '&quot;')
                .replace(/'/g, '&#039;');
            // Links [text](url)
            html = html.replace(/\[([^\]]+)\]\((https?:[^)\s]+)\)/g, '<a href="$2" target="_blank" rel="noopener">$1<\/a>');
            // Bold **text**
            html = html.replace(/\*\*([^*]+)\*\*/g, '<strong>$1<\/strong>');
            // Italic *text*
            html = html.replace(/(?<!\*)\*([^*]+)\*(?!\*)/g, '<em>$1<\/em>');
            // Ordered lists
            html = html.replace(/(?:^|\n)(\d+)\.\s+(.+)(?=\n|$)/g, (m, n, item) => `\n<li>${item}<\/li>`);
            html = html.replace(/(?:\n<li>[^]*?<\/li>)+/g, (m) => `<ol>${m}\n<\/ol>`);
            // Unordered lists
            html = html.replace(/(?:^|\n)-\s+(.+)(?=\n|$)/g, '\n<li>$1<\/li>');
            html = html.replace(/(?:\n<li>[^]*?<\/li>)+/g, (m) => `<ul>${m}\n<\/ul>`);
            // Line breaks
            html = html.replace(/\n/g, '<br>');
            return html;
        }

        // Draft autosave
        const FAQ_DRAFT_KEY = 'faq_draft';
        function saveFaqDraft() {
            const draft = {
                question: document.getElementById('faqQuestion')?.value || '',
                answer: document.getElementById('faqAnswer')?.value || '',
                category: document.getElementById('faqCategory')?.value || 'general',
                featured: !!document.getElementById('faqFeatured')?.checked
            };
            try { localStorage.setItem(FAQ_DRAFT_KEY, JSON.stringify(draft)); } catch {}
        }
        function loadFaqDraft() {
            try {
                const raw = localStorage.getItem(FAQ_DRAFT_KEY);
                return raw ? JSON.parse(raw) : null;
            } catch { return null; }
        }
        function clearFaqDraft() {
            try { localStorage.removeItem(FAQ_DRAFT_KEY); } catch {}
        }

        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        
        function showNotification(message, type = 'info') {
          
            const notification = document.createElement('div');
            notification.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                background: ${type === 'success' ? 'var(--success)' : type === 'error' ? 'var(--error)' : 'var(--primary)'};
                color: var(--light);
                padding: 1rem 1.5rem;
                border-radius: 8px;
                box-shadow: var(--shadow);
                z-index: 10000;
                font-weight: 500;
                max-width: 300px;
                animation: slideIn 0.3s ease;
            `;
            notification.innerHTML = `
                <i class="fas fa-${type === 'success' ? 'check-circle' : type === 'error' ? 'exclamation-circle' : 'info-circle'}"></i>
                ${message}
            `;
            
            document.body.appendChild(notification);
            
           
            setTimeout(() => {
                notification.style.animation = 'slideOut 0.3s ease';
                setTimeout(() => {
                    if (notification.parentNode) {
                        notification.parentNode.removeChild(notification);
                    }
                }, 300);
            }, 3000);
        }

       
        let chatData = [];
        let currentChatPage = 1;
        let currentChatFilter = 'all';
        let currentChatSearch = '';
        let chatItemsPerPage = 10;

     
        function stripHtml(html) {
            if (!html) return '';
            const tmp = document.createElement('div');
            tmp.innerHTML = html;
            return tmp.textContent || tmp.innerText || '';
        }

        
        function initializeTinyMCE() {
          
            if (typeof tinymce !== 'undefined') {
                try {
               
                    if (tinymce.get('visaDescriptionEditor')) {
                        tinymce.get('visaDescriptionEditor').remove();
                    }
                    
                    tinymce.init({
                        selector: '#visaDescriptionEditor',
                        height: 400,
                        plugins: [
                            'advlist', 'autolink', 'lists', 'link', 'image', 'charmap', 'preview',
                            'anchor', 'searchreplace', 'visualblocks', 'code', 'fullscreen',
                            'insertdatetime', 'media', 'table', 'help', 'wordcount', 'emoticons',
                            'template', 'paste', 'textpattern', 'nonbreaking', 'pagebreak',
                            'quickbars', 'codesample', 'directionality', 'visualchars', 'textcolor'
                        ],
                        toolbar: [
                            'undo redo | formatselect fontselect fontsizeselect',
                            'bold italic underline strikethrough | forecolor backcolor | removeformat',
                            'alignleft aligncenter alignright alignjustify | bullist numlist outdent indent',
                            'link image media table | code fullscreen preview'
                        ].join(' | '),
                        menubar: false,
                        content_style: `
                            body { 
                                font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; 
                                font-size: 16px; 
                                line-height: 1.6; 
                                color: #333; 
                                padding: 20px; 
                                margin: 0;
                            }
                            p { margin: 0 0 16px 0; }
                            h1, h2, h3, h4, h5, h6 { margin: 16px 0 8px 0; color: #1a1a1a; }
                            ul, ol { margin: 16px 0; padding-left: 24px; }
                            li { margin: 8px 0; }
                            blockquote { 
                                border-left: 4px solid #6366f1; 
                                margin: 16px 0; 
                                padding: 12px 20px; 
                                background: #f8fafc; 
                                font-style: italic;
                            }
                            table { border-collapse: collapse; width: 100%; margin: 16px 0; }
                            th, td { border: 1px solid #e2e8f0; padding: 12px; text-align: left; }
                            th { background: #f1f5f9; font-weight: 600; }
                        `,
                        branding: false,
                        promotion: false,
                        elementpath: false,
                        resize: true,
                        statusbar: true,
                        paste_as_text: false,
                        paste_enable_default_filters: true,
                        paste_word_valid_elements: "b,strong,i,em,h1,h2,h3,h4,h5,h6,p,br,ul,ol,li",
                        paste_retain_style_properties: "color background-color font-size font-family",
                        browser_spellcheck: true,
                        contextmenu: true,
                        quickbars_selection_toolbar: 'bold italic underline | quicklink h2 h3 blockquote',
                        quickbars_insert_toolbar: 'quickimage quicktable',
                        toolbar_mode: 'wrap',
                        toolbar_sticky: true,
                        toolbar_sticky_offset: 0,
                        setup: function(editor) {
                            editor.on('change', function() {
                               
                                document.getElementById('visaDescription').value = editor.getContent();
                            });
                        },
                        init_instance_callback: function(editor) {
                            console.log('TinyMCE initialized successfully');
                         
                            document.getElementById('visaDescription').style.display = 'none';
                            document.getElementById('visaDescriptionEditor').style.display = 'block';
                        }
                    });
                    return;
                } catch (error) {
                    console.error('Error initializing TinyMCE:', error);
                }
            }
            
            
            if (typeof Quill !== 'undefined') {
                try {
                    
                    document.getElementById('visaDescriptionEditor').innerHTML = '<div id="quillEditor"></div>';
                    
                    window.quillEditor = new Quill('#quillEditor', {
                        theme: 'snow',
                        modules: {
                            toolbar: [
                                [
                                    { 'header': [1, 2, 3, 4, 5, 6, false] },
                                    { 'font': [] },
                                    { 'size': ['small', false, 'large', 'huge'] }
                                ],
                                [
                                    'bold', 'italic', 'underline', 'strike',
                                    { 'color': [] }, { 'background': [] }
                                ],
                                [
                                    { 'align': [] },
                                    { 'list': 'ordered'}, { 'list': 'bullet' },
                                    { 'indent': '-1'}, { 'indent': '+1' }
                                ],
                                [
                                    'blockquote', 'code-block',
                                    'link', 'image', 'clean'
                                ]
                            ]
                        },
                        placeholder: 'Enter visa description...',
                        bounds: '#quillEditor'
                    });
                    
                   
                    window.quillEditor.on('text-change', function() {
                        document.getElementById('visaDescription').value = window.quillEditor.root.innerHTML;
                    });
                    
                    console.log('Quill.js initialized successfully');
                    document.getElementById('visaDescription').style.display = 'none';
                    document.getElementById('visaDescriptionEditor').style.display = 'block';
                    return;
                } catch (error) {
                    console.error('Error initializing Quill.js:', error);
                }
            }
            
            console.log('No rich text editor available, using fallback textarea');
            document.getElementById('visaDescription').style.display = 'block';
            document.getElementById('visaDescriptionEditor').style.display = 'none';
        }

        // Enhance textareas for better UX: auto-resize to content height
        function enhanceTextAreas() {
            const textareas = document.querySelectorAll('textarea.form-textarea, #faqAnswer');
            textareas.forEach(ta => {
                const autosize = () => {
                    ta.style.height = 'auto';
                    ta.style.height = Math.min(ta.scrollHeight, 600) + 'px';
                };
                ta.addEventListener('input', autosize);
                autosize();
            });
        }

        function safeInvoke(fn, label) {
            try {
                fn();
            } catch (error) {
                console.error('Initialization error in ' + label + ':', error);
            }
        }

        function initializeAdminPanel() {
            console.log('Admin panel initializing...');
            console.log('TinyMCE available:', typeof tinymce !== 'undefined');

       
            safeInvoke(() => setupNavigation(), 'setupNavigation');
            safeInvoke(() => setupMobileMenu(), 'setupMobileMenu');
            safeInvoke(() => enhanceTextAreas(), 'enhanceTextAreas');


            setTimeout(() => {
                safeInvoke(() => initializeTinyMCE(), 'initializeTinyMCE');
            }, 500);

            
            safeInvoke(() => loadVisaTypes(), 'loadVisaTypes');
            safeInvoke(() => loadPackages(), 'loadPackages');
            safeInvoke(() => setupPackageFilter(), 'setupPackageFilter');
            safeInvoke(() => loadDependentCosts(), 'loadDependentCosts');
            safeInvoke(() => loadDropdownOptions(), 'loadDropdownOptions');
            safeInvoke(() => loadApplicantDropdownOptions(), 'loadApplicantDropdownOptions');
            safeInvoke(() => loadSettings(), 'loadSettings');
            safeInvoke(() => updateStats(), 'updateStats');
            safeInvoke(() => loadChatData(), 'loadChatData'); 
            safeInvoke(() => initializeFileManager(), 'initializeFileManager'); 

         
            safeInvoke(() => setupApplicantDropdownForm(), 'setupApplicantDropdownForm');
        }

        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', initializeAdminPanel);
        } else {
            initializeAdminPanel();
        }

        
        function setupNavigation() {
            const navLinks = document.querySelectorAll('.nav-link');
            const sections = document.querySelectorAll('.content-section');
            const sidebar = document.getElementById('sidebar');

            navLinks.forEach(link => {
                link.addEventListener('click', function(e) {
                    e.preventDefault();
                    const targetSection = this.getAttribute('data-section');
                    
                
                    navLinks.forEach(l => l.classList.remove('active'));
                    this.classList.add('active');
                    
                    
                    sections.forEach(section => {
                        section.classList.remove('active');
                        if (section.id === targetSection) {
                            section.classList.add('active');
                        }
                    });

                    if (sidebar && sidebar.classList.contains('active')) {
                        sidebar.classList.remove('active');
                    }
                });
            });
        }

      
        function setupMobileMenu() {
            const mobileMenuBtn = document.getElementById('mobileMenuBtn');
            const sidebar = document.getElementById('sidebar');

            mobileMenuBtn.addEventListener('click', function() {
                sidebar.classList.toggle('active');
            });

        
            document.addEventListener('click', function(e) {
                if (!sidebar.contains(e.target) && !mobileMenuBtn.contains(e.target)) {
                    sidebar.classList.remove('active');
                }
            });
        }

        
        let currentFilter = 'all';
        let currentSort = 'name';
        let filteredVisas = [];

        function loadVisaTypes() {
            updateVisaStats();
            renderVisaGrid();
        }

        function updateVisaStats() {
            const totalVisas = visaTypes.length;
            const activeVisas = visaTypes.filter(v => v.active).length;
            const inactiveVisas = totalVisas - activeVisas;
            const avgProcessing = totalVisas > 0 ? Math.round(visaTypes.reduce((sum, v) => sum + v.processingTime, 0) / totalVisas) : 0;

            document.getElementById('totalVisasCount').textContent = totalVisas;
            document.getElementById('activeVisasCount').textContent = activeVisas;
            document.getElementById('inactiveVisasCount').textContent = inactiveVisas;
            document.getElementById('avgProcessingTime').textContent = avgProcessing;
        }

        function renderVisaGrid() {
            const visaList = document.getElementById('visaList');
            visaList.innerHTML = '';

      
            filteredVisas = [...visaTypes];
            
           
            if (currentFilter === 'active') {
                filteredVisas = filteredVisas.filter(v => v.active);
            } else if (currentFilter === 'inactive') {
                filteredVisas = filteredVisas.filter(v => !v.active);
            }

          
            filteredVisas.sort((a, b) => {
                switch (currentSort) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'price':
                        return a.basePrice - b.basePrice;
                    case 'processing':
                        return a.processingTime - b.processingTime;
                    default:
                        return 0;
                }
            });

            const visaGrid = document.createElement('div');
            visaGrid.className = 'visa-grid';

            filteredVisas.forEach(visa => {
                const visaItem = document.createElement('div');
                visaItem.className = `visa-item ${visa.active ? 'active' : 'inactive'}`;
                visaItem.innerHTML = `
                    <div class="visa-status ${visa.active ? 'active' : 'inactive'}">
                        ${visa.active ? 'Active' : 'Inactive'}
                    </div>
                    <div class="visa-header">
                        <div class="visa-name">${visa.name}</div>
                        <div class="visa-description">${stripHtml(visa.description)}</div>
                    </div>
                    <div class="visa-details">
                        <div class="visa-detail">
                            <div class="visa-detail-label">Processing Time</div>
                            <div class="visa-detail-value">${visa.processingTime} days</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Base Price</div>
                            <div class="visa-detail-value">${visa.basePrice}</div>
                        </div>
                    </div>
                    <div class="visa-actions">
                        <button class="btn btn-secondary btn-sm" onclick="previewVisaDescription(${visa.id})" title="Preview Description">
                            <i class="fas fa-eye"></i>
                        </button>
                        <button class="btn btn-secondary btn-sm" onclick="editVisa(${visa.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="toggleVisaStatus(${visa.id})" title="${visa.active ? 'Deactivate' : 'Activate'}">
                            <i class="fas fa-${visa.active ? 'pause' : 'play'}"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteVisa(${visa.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                visaGrid.appendChild(visaItem);
            });

            visaList.appendChild(visaGrid);

            
            if (filteredVisas.length === 0) {
                const noVisasMessage = document.createElement('div');
                noVisasMessage.style.textAlign = 'center';
                noVisasMessage.style.padding = '3rem';
                noVisasMessage.style.color = 'var(--gray)';
                noVisasMessage.innerHTML = `
                    <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>No visa types found</h3>
                    <p>Try adjusting your search or filters</p>
                `;
                visaList.appendChild(noVisasMessage);
            }
        }

        function filterVisas(filter = null) {
            if (filter) {
                currentFilter = filter;
              
                document.querySelectorAll('.filter-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            } else {
              
                const searchTerm = document.getElementById('visaSearch').value.toLowerCase();
                filteredVisas = visaTypes.filter(visa => 
                    visa.name.toLowerCase().includes(searchTerm) ||
                    stripHtml(visa.description).toLowerCase().includes(searchTerm)
                );
            }
            renderVisaGrid();
        }

        function sortVisas(sortBy) {
            currentSort = sortBy;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.textContent.includes('Sort by')) {
                    btn.classList.remove('active');
                }
            });
            event.target.classList.add('active');
            renderVisaGrid();
        }

        function toggleVisaStatus(visaId) {
            const visa = visaTypes.find(v => v.id === visaId);
            if (visa) {
                visa.active = !visa.active;
                saveVisaTypes();
                loadVisaTypes();
                showAlert(`Visa type ${visa.active ? 'activated' : 'deactivated'} successfully`, 'success');
            }
        }

        function bulkActivate() {
            if (confirm('Are you sure you want to activate all visible visa types?')) {
                filteredVisas.forEach(visa => {
                    visa.active = true;
                });
                saveVisaTypes();
                loadVisaTypes();
                showAlert(`${filteredVisas.length} visa types activated successfully`, 'success');
            }
        }

        function bulkDeactivate() {
            if (confirm('Are you sure you want to deactivate all visible visa types?')) {
                filteredVisas.forEach(visa => {
                    visa.active = false;
                });
                saveVisaTypes();
                loadVisaTypes();
                showAlert(`${filteredVisas.length} visa types deactivated successfully`, 'success');
            }
        }

        function showQuickAddMenu() {
            const quickAddOptions = [
                { name: 'Business Visa', category: 'business', processingTime: 15, basePrice: 299 },
                { name: 'Student Visa', category: 'student', processingTime: 20, basePrice: 249 },
                { name: 'Family Visa', category: 'family', processingTime: 60, basePrice: 399 },
                { name: 'Work Visa', category: 'work', processingTime: 30, basePrice: 499 },
                { name: 'Tourist Visa', category: 'tourism', processingTime: 10, basePrice: 199 },
                { name: 'Partner Visa', category: 'family', processingTime: 45, basePrice: 449 },
                { name: 'Investor Visa', category: 'business', processingTime: 90, basePrice: 999 },
                { name: 'Graduate Visa', category: 'student', processingTime: 25, basePrice: 349 }
            ];

            let optionsHtml = '';
            quickAddOptions.forEach(option => {
                optionsHtml += `
                    <div class="quick-add-option" onclick="quickAddVisa('${option.name}', '${option.category}', ${option.processingTime}, ${option.basePrice})">
                        <strong>${option.name}</strong>
                        <span>${option.processingTime} days  ${option.basePrice}</span>
                    </div>
                `;
            });

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Quick Add Visa Types</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${optionsHtml}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function quickAddVisa(name, category, processingTime, basePrice) {
            const visaData = {
                id: Math.max(...visaTypes.map(v => v.id), 0) + 1,
                name: name,
                description: `Standard ${name.toLowerCase()} for UK applications`,
                processingTime: processingTime,
                basePrice: basePrice,
                category: category,
                requirements: ['Valid passport', 'Proof of funds', 'Application form'],
                active: true,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            visaTypes.push(visaData);
            saveVisaTypes();
            loadVisaTypes();
            document.querySelector('.modal').remove();
            showAlert(`${name} added successfully`, 'success');
        }

        function showQuickAddDropdownMenu() {
            const quickAddOptions = [
                { 
                    name: 'Countries', 
                    description: 'List of countries for nationality',
                    options: ['United States', 'United Kingdom', 'Canada', 'Australia', 'France', 'Germany', 'Italy', 'Spain', 'Japan', 'China', 'India', 'Brazil', 'Mexico', 'South Africa', 'Nigeria', 'Pakistan', 'Bangladesh', 'Philippines', 'Thailand', 'Vietnam']
                },
                { 
                    name: 'Education Level', 
                    description: 'Educational qualification levels',
                    options: ['High School', 'Associate Degree', 'Bachelor Degree', 'Master Degree', 'PhD', 'Diploma', 'Certificate', 'No Formal Education']
                },
                { 
                    name: 'Marital Status', 
                    description: 'Marital status options',
                    options: ['Single', 'Married', 'Divorced', 'Widowed', 'Separated', 'Civil Partnership']
                },
                { 
                    name: 'Income Range', 
                    description: 'Annual income brackets',
                    options: ['Under 10,000', '10,000 - 25,000', '25,000 - 50,000', '50,000 - 75,000', '75,000 - 100,000', 'Over 100,000']
                },
                { 
                    name: 'Language Proficiency', 
                    description: 'English language proficiency levels',
                    options: ['Beginner', 'Elementary', 'Intermediate', 'Upper Intermediate', 'Advanced', 'Native Speaker']
                },
                { 
                    name: 'Accommodation Type', 
                    description: 'Types of accommodation',
                    options: ['Hotel', 'Hostel', 'Apartment', 'House', 'Student Residence', 'Family Home', 'Other']
                }
            ];

            let optionsHtml = '';
            quickAddOptions.forEach(option => {
                optionsHtml += `
                    <div class="quick-add-option" onclick="quickAddDropdown('${option.name}', '${option.description}', '${option.options.join('\\n')}')">
                        <strong>${option.name}</strong>
                        <span>${option.options.length} options  ${option.description}</span>
                    </div>
                `;
            });

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 500px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Quick Add Dropdown Categories</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="max-height: 400px; overflow-y: auto;">
                        ${optionsHtml}
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        function quickAddDropdown(name, description, optionsText) {
            const dropdownData = {
                id: Math.max(...dropdownOptions.map(d => d.id), 0) + 1,
                name: name,
                description: description,
                options: optionsText.split('\n').map((text, index) => ({
                    value: text.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''),
                    text: text.trim(),
                    sortOrder: index + 1,
                    active: true
                })),
                defaultValue: '',
                sortOrder: 'alphabetical',
                required: true,
                active: true,
                usageCount: 0,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            dropdownOptions.push(dropdownData);
            saveDropdownOptions();
            loadDropdownOptions();
            document.querySelector('.modal').remove();
            showAlert(`${name} dropdown category added successfully`, 'success');
        }

        function openVisaModal(visaId = null) {
            const modal = document.getElementById('visaModal');
            const title = document.getElementById('visaModalTitle');
            const form = document.getElementById('visaForm');

           
            modal.classList.add('active');

           
            setTimeout(() => {
                initializeTinyMCE();
                
              
                setTimeout(() => {
                    if (visaId) {
                        const visa = visaTypes.find(v => v.id === visaId);
                        if (visa) {
                            if (tinymce.get('visaDescriptionEditor')) {
                                tinymce.get('visaDescriptionEditor').setContent(visa.description || '');
                            } else if (window.quillEditor) {
                                window.quillEditor.root.innerHTML = visa.description || '';
                            }
                        }
                    } else {
                        if (tinymce.get('visaDescriptionEditor')) {
                            tinymce.get('visaDescriptionEditor').setContent('');
                        } else if (window.quillEditor) {
                            window.quillEditor.root.innerHTML = '';
                        }
                    }
                }, 200);
            }, 100);

            if (visaId) {
                const visa = visaTypes.find(v => v.id === visaId);
                title.textContent = 'Edit Visa Type';
                form.dataset.visaId = visaId;
                
                document.getElementById('visaName').value = visa.name;
                document.getElementById('processingTime').value = visa.processingTime;
                document.getElementById('basePrice').value = visa.basePrice;
                document.getElementById('visaCategory').value = visa.category || 'other';
                document.getElementById('visaRequirements').value = (visa.requirements || []).join('\n');
                document.getElementById('visaActive').value = visa.active.toString();
            } else {
                title.textContent = 'Add New Visa Type';
                form.dataset.visaId = '';
                form.reset();
             
                document.getElementById('visaCategory').value = 'other';
                document.getElementById('visaActive').value = 'true';
            }
        }

        function closeVisaModal() {
         
            if (tinymce.get('visaDescriptionEditor')) {
                tinymce.get('visaDescriptionEditor').remove();
            }
          
            if (window.quillEditor) {
                window.quillEditor = null;
            }
            document.getElementById('visaModal').classList.remove('active');
        }

        function editVisa(visaId) {
            openVisaModal(visaId);
        }

        function deleteVisa(visaId) {
            if (confirm('Are you sure you want to delete this visa type?')) {
                visaTypes = visaTypes.filter(v => v.id !== visaId);
                saveVisaTypes();
                loadVisaTypes();
                updateStats();
                showAlert('Visa type deleted successfully', 'success');
            }
        }

        function previewVisaDescription(visaId) {
            const visa = visaTypes.find(v => v.id === visaId);
            if (!visa) return;

            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 800px;">
                    <div class="modal-header">
                        <h3 class="modal-title">${visa.name} - Description Preview</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 1rem 0;">
                        <div style="background: var(--light); padding: 1.5rem; border-radius: 8px; border: 1px solid var(--lighter-gray);">
                            ${visa.description || '<em>No description available</em>'}
                        </div>
                    </div>
                    <div style="display: flex; gap: 1rem; justify-content: flex-end; margin-top: 1.5rem;">
                        <button class="btn btn-secondary" onclick="this.closest('.modal').remove()">Close</button>
                        <button class="btn btn-primary" onclick="editVisa(${visa.id}); this.closest('.modal').remove()">Edit</button>
                    </div>
                </div>
            `;
            document.body.appendChild(modal);
        }

        
        function loadPackages() {
            const packageList = document.getElementById('packageList');
            packageList.innerHTML = '';

          
            const filterEl = document.getElementById('packageFilter');
            const filter = filterEl ? filterEl.value : 'all';
            let visiblePackages = [...packages];
            if (filter === 'active') {
                visiblePackages = visiblePackages.filter(p => p.active);
            } else if (filter === 'inactive') {
                visiblePackages = visiblePackages.filter(p => !p.active);
            }

            visiblePackages.forEach(pkg => {
                const safeName = pkg && pkg.name ? pkg.name : 'Untitled Package';
                const safePrice = (pkg && pkg.price !== undefined && pkg.price !== null && !isNaN(Number(pkg.price))) ? Number(pkg.price) : 0;
                const features = Array.isArray(pkg?.features) ? pkg.features : [];
                const featuresCount = features.length;
                
                const contentsPreview = pkg && typeof pkg.contents === 'string' && pkg.contents.trim()
                    ? pkg.contents.trim().slice(0, 80) + (pkg.contents.trim().length > 80 ? '' : '')
                    : '';
                const descriptionLine = contentsPreview
                    ? `${safePrice}  ${featuresCount} features  ${contentsPreview}`
                    : `${safePrice}  ${featuresCount} features`;

                const packageItem = document.createElement('div');
                packageItem.className = 'visa-item';
                packageItem.innerHTML = `
                    <div class="visa-info">
                        <div class="visa-name">${safeName}</div>
                        <div class="visa-description">${descriptionLine}</div>
                    </div>
                    <div class="visa-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editPackage(${pkg.id})">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deletePackage(${pkg.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                packageList.appendChild(packageItem);
            });
 
            if (packageList.children.length === 0) {
                const empty = document.createElement('div');
                empty.style.textAlign = 'center';
                empty.style.padding = '3rem';
                empty.style.color = 'var(--gray)';
                empty.innerHTML = `
                    <i class="fas fa-box" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>No packages found</h3>
                    <p>Try changing the filter or add a new package</p>
                `;
                packageList.appendChild(empty);
            }
        }

        function openPackageModal(packageId = null) {
            const modal = document.getElementById('packageModal');
            const title = document.getElementById('packageModalTitle');
            const form = document.getElementById('packageForm');

            if (packageId) {
                const pkg = packages.find(p => p.id === packageId);
                title.textContent = 'Edit Package';
                form.dataset.packageId = packageId;
                
                document.getElementById('packageName').value = (pkg && pkg.name) ? pkg.name : '';
                document.getElementById('packagePrice').value = (pkg && pkg.price != null) ? pkg.price : '';
                const features = Array.isArray(pkg?.features) ? pkg.features : [];
                document.getElementById('packageFeatures').value = features.join('\n');
                document.getElementById('packageActive').value = (pkg && typeof pkg.active === 'boolean') ? pkg.active.toString() : 'true';
            } else {
                title.textContent = 'Add Package';
                form.dataset.packageId = '';
                form.reset();
            }

            modal.classList.add('active');
        }

        function closePackageModal() {
            document.getElementById('packageModal').classList.remove('active');
        }

        
        function setupPackageFilter() {
            const filter = document.getElementById('packageFilter');
            if (!filter) return;
            filter.addEventListener('change', function() {
                loadPackages();
            });
        }

        function editPackage(packageId) {
            openPackageModal(packageId);
        }

        function deletePackage(packageId) {
            if (confirm('Are you sure you want to delete this package?')) {
                packages = packages.filter(p => p.id !== packageId);
                savePackages();
                loadPackages();
                updateStats();
                showAlert('Package deleted successfully', 'success');
            }
        }

     
        let currentDependentFilter = 'all';
        let currentDependentSort = 'visaType';
        let filteredDependentCosts = [];

        function loadDependentCosts() {
            updateDependentCostStats();
            renderDependentCostGrid();
            populateVisaTypeDropdown();
        }

        function updateDependentCostStats() {
            const totalRules = dependentCosts.length;
            const activeRules = dependentCosts.filter(d => d.active).length;
            const avgCost = totalRules > 0 ? Math.round(dependentCosts.reduce((sum, d) => sum + d.additionalCost, 0) / totalRules) : 0;
            const maxDependents = Math.max(...dependentCosts.map(d => d.maxDependents || 0), 0);

            document.getElementById('totalDependentRules').textContent = totalRules;
            document.getElementById('activeDependentRules').textContent = activeRules;
            document.getElementById('avgDependentCost').textContent = `${avgCost}`;
            document.getElementById('maxDependents').textContent = maxDependents;
        }

        function populateVisaTypeDropdown() {
            const dropdown = document.getElementById('dependentVisaType');
            dropdown.innerHTML = '<option value="">Select visa type</option>';
            
            visaTypes.filter(v => v.active).forEach(visa => {
                const option = document.createElement('option');
                option.value = visa.id;
                option.textContent = visa.name;
                dropdown.appendChild(option);
            });
        }

        function renderDependentCostGrid() {
            const dependentCostList = document.getElementById('dependentCostList');
            dependentCostList.innerHTML = '';

          
            filteredDependentCosts = [...dependentCosts];
            
          
            if (currentDependentFilter === 'active') {
                filteredDependentCosts = filteredDependentCosts.filter(d => d.active);
            } else if (currentDependentFilter === 'inactive') {
                filteredDependentCosts = filteredDependentCosts.filter(d => !d.active);
            }
            filteredDependentCosts.sort((a, b) => {
                switch (currentDependentSort) {
                    case 'visaType':
                        return a.visaTypeName.localeCompare(b.visaTypeName);
                    case 'cost':
                        return a.additionalCost - b.additionalCost;
                    case 'dependentType':
                        return a.dependentTypeLabel.localeCompare(b.dependentTypeLabel);
                    default:
                        return 0;
                }
            });

           
            const dependentCostGrid = document.createElement('div');
            dependentCostGrid.className = 'visa-grid';

            filteredDependentCosts.forEach(dependentCost => {
                const dependentCostItem = document.createElement('div');
                dependentCostItem.className = `visa-item ${dependentCost.active ? 'active' : 'inactive'}`;
                dependentCostItem.innerHTML = `
                    <div class="visa-status ${dependentCost.active ? 'active' : 'inactive'}">
                        ${dependentCost.active ? 'Active' : 'Inactive'}
                    </div>
                    <div class="visa-header">
                        <div class="visa-name">${dependentCost.visaTypeName} - ${dependentCost.dependentTypeLabel}</div>
                        <div class="visa-description">${dependentCost.notes || 'Additional cost for dependents'}</div>
                    </div>
                    <div class="visa-details">
                        <div class="visa-detail">
                            <div class="visa-detail-label">Additional Cost</div>
                            <div class="visa-detail-value">${dependentCost.additionalCost}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Max Dependents</div>
                            <div class="visa-detail-value">${dependentCost.maxDependents || 'Unlimited'}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Processing Time</div>
                            <div class="visa-detail-value">+${dependentCost.processingTime || 0} days</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Requirements</div>
                            <div class="visa-detail-value">${(dependentCost.requirements || []).length} items</div>
                        </div>
                    </div>
                    <div class="visa-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editDependentCost(${dependentCost.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="toggleDependentCostStatus(${dependentCost.id})" title="${dependentCost.active ? 'Deactivate' : 'Activate'}">
                            <i class="fas fa-${dependentCost.active ? 'pause' : 'play'}"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDependentCost(${dependentCost.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                dependentCostGrid.appendChild(dependentCostItem);
            });

            dependentCostList.appendChild(dependentCostGrid);

          
            if (filteredDependentCosts.length === 0) {
                const noDependentCostsMessage = document.createElement('div');
                noDependentCostsMessage.style.textAlign = 'center';
                noDependentCostsMessage.style.padding = '3rem';
                noDependentCostsMessage.style.color = 'var(--gray)';
                noDependentCostsMessage.innerHTML = `
                    <i class="fas fa-users" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>No dependent cost rules found</h3>
                    <p>Try adjusting your search or filters, or add a new dependent cost rule</p>
                `;
                dependentCostList.appendChild(noDependentCostsMessage);
            }
        }

        function filterDependentCosts(filter = null) {
            if (filter) {
                currentDependentFilter = filter;
               
                document.querySelectorAll('.visa-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            } else {
          
                const searchTerm = document.getElementById('dependentCostSearch').value.toLowerCase();
                filteredDependentCosts = dependentCosts.filter(dependentCost => 
                    dependentCost.visaTypeName.toLowerCase().includes(searchTerm) ||
                    dependentCost.dependentTypeLabel.toLowerCase().includes(searchTerm) ||
                    (dependentCost.notes && dependentCost.notes.toLowerCase().includes(searchTerm))
                );
            }
            renderDependentCostGrid();
        }

        function sortDependentCosts(sortBy) {
            currentDependentSort = sortBy;
           
            document.querySelectorAll('.visa-filters .filter-btn').forEach(btn => {
                if (btn.textContent.includes('Sort by')) {
                    btn.classList.remove('active');
                }
            });
            event.target.classList.add('active');
            renderDependentCostGrid();
        }

        function openDependentCostModal(dependentCostId = null) {
            const modal = document.getElementById('dependentCostModal');
            const title = document.getElementById('dependentCostModalTitle');
            const form = document.getElementById('dependentCostForm');

            
            populateVisaTypeDropdown();

            if (dependentCostId) {
                const dependentCost = dependentCosts.find(d => d.id === dependentCostId);
                title.textContent = 'Edit Dependent Cost Rule';
                form.dataset.dependentCostId = dependentCostId;
                
                document.getElementById('dependentVisaType').value = dependentCost.visaTypeId;
                document.getElementById('dependentType').value = dependentCost.dependentType;
                document.getElementById('dependentCost').value = dependentCost.additionalCost;
                document.getElementById('maxDependents').value = dependentCost.maxDependents || '';
                document.getElementById('dependentProcessingTime').value = dependentCost.processingTime || '';
                document.getElementById('dependentRequirements').value = (dependentCost.requirements || []).join('\n');
                document.getElementById('dependentNotes').value = dependentCost.notes || '';
                document.getElementById('dependentActive').value = dependentCost.active.toString();
            } else {
                title.textContent = 'Add Dependent Cost Rule';
                form.dataset.dependentCostId = '';
                form.reset();
                document.getElementById('dependentActive').value = 'true';
            }

            modal.classList.add('active');
        }

        function closeDependentCostModal() {
            document.getElementById('dependentCostModal').classList.remove('active');
        }

        function editDependentCost(dependentCostId) {
            openDependentCostModal(dependentCostId);
        }

        function toggleDependentCostStatus(dependentCostId) {
            const dependentCost = dependentCosts.find(d => d.id === dependentCostId);
            if (dependentCost) {
                dependentCost.active = !dependentCost.active;
                saveDependentCosts();
                loadDependentCosts();
                showAlert(`Dependent cost rule ${dependentCost.active ? 'activated' : 'deactivated'} successfully`, 'success');
            }
        }

        function deleteDependentCost(dependentCostId) {
            if (confirm('Are you sure you want to delete this dependent cost rule?')) {
                dependentCosts = dependentCosts.filter(d => d.id !== dependentCostId);
                saveDependentCosts();
                loadDependentCosts();
                updateStats();
                showAlert('Dependent cost rule deleted successfully', 'success');
            }
        }

      
        let currentDropdownFilter = 'all';
        let currentDropdownSort = 'name';
        let currentDropdownSearchTerm = '';
        let filteredDropdowns = [];

        function loadDropdownOptions() {
            updateDropdownStats();
            renderDropdownGrid();
        }

        function updateDropdownStats() {
            const totalDropdowns = dropdownOptions.length;
            const activeDropdowns = dropdownOptions.filter(d => d.active).length;
            const totalOptions = dropdownOptions.reduce((sum, d) => sum + d.options.length, 0);
            const mostUsed = dropdownOptions.length > 0 ? dropdownOptions.reduce((max, d) => d.usageCount > max.usageCount ? d : max, dropdownOptions[0]) : null;

            document.getElementById('totalDropdowns').textContent = totalDropdowns;
            document.getElementById('activeDropdowns').textContent = activeDropdowns;
            document.getElementById('totalOptions').textContent = totalOptions;
            document.getElementById('mostUsed').textContent = mostUsed ? mostUsed.name : 'N/A';
        }

        function renderDropdownGrid() {
            const dropdownList = document.getElementById('dropdownList');
            dropdownList.innerHTML = '';

           
            filteredDropdowns = [...dropdownOptions];
            
         
            if (currentDropdownFilter === 'active') {
                filteredDropdowns = filteredDropdowns.filter(d => d.active);
            } else if (currentDropdownFilter === 'inactive') {
                filteredDropdowns = filteredDropdowns.filter(d => !d.active);
            }

           
            if (currentDropdownSearchTerm && currentDropdownSearchTerm.trim() !== '') {
                const term = currentDropdownSearchTerm.toLowerCase();
                filteredDropdowns = filteredDropdowns.filter(dropdown =>
                    dropdown.name.toLowerCase().includes(term) ||
                    dropdown.description.toLowerCase().includes(term)
                );
            }

           
            filteredDropdowns.sort((a, b) => {
                switch (currentDropdownSort) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'options':
                        return b.options.length - a.options.length;
                    case 'usage':
                        return b.usageCount - a.usageCount;
                    default:
                        return 0;
                }
            });

            
            const dropdownGrid = document.createElement('div');
            dropdownGrid.className = 'visa-grid';

            filteredDropdowns.forEach(dropdown => {
                const activeOptions = dropdown.options.filter(o => o.active).length;
                const dropdownItem = document.createElement('div');
                dropdownItem.className = `visa-item ${dropdown.active ? 'active' : 'inactive'}`;
                dropdownItem.innerHTML = `
                    <div class="visa-status ${dropdown.active ? 'active' : 'inactive'}">
                        ${dropdown.active ? 'Active' : 'Inactive'}
                    </div>
                    <div class="visa-header">
                        <div class="visa-name">${dropdown.name}</div>
                        <div class="visa-description">${dropdown.description}</div>
                    </div>
                    <div class="visa-details">
                        <div class="visa-detail">
                            <div class="visa-detail-label">Options</div>
                            <div class="visa-detail-value">${activeOptions}/${dropdown.options.length}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Required</div>
                            <div class="visa-detail-value">${dropdown.required ? 'Yes' : 'No'}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Sort Order</div>
                            <div class="visa-detail-value">${dropdown.sortOrder}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Usage</div>
                            <div class="visa-detail-value">${dropdown.usageCount}</div>
                        </div>
                    </div>
                    <div class="visa-actions">
                        <button class="btn btn-secondary btn-sm" onclick="editDropdown(${dropdown.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="btn btn-success btn-sm" onclick="toggleDropdownStatus(${dropdown.id})" title="${dropdown.active ? 'Deactivate' : 'Activate'}">
                            <i class="fas fa-${dropdown.active ? 'pause' : 'play'}"></i>
                        </button>
                        <button class="btn btn-danger btn-sm" onclick="deleteDropdown(${dropdown.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                `;
                dropdownGrid.appendChild(dropdownItem);
            });

            dropdownList.appendChild(dropdownGrid);

      
            if (filteredDropdowns.length === 0) {
                const noDropdownsMessage = document.createElement('div');
                noDropdownsMessage.style.textAlign = 'center';
                noDropdownsMessage.style.padding = '3rem';
                noDropdownsMessage.style.color = 'var(--gray)';
                noDropdownsMessage.innerHTML = `
                    <i class="fas fa-list-ul" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                    <h3>No dropdown categories found</h3>
                    <p>Try adjusting your search or filters, or add a new dropdown category</p>
                `;
                dropdownList.appendChild(noDropdownsMessage);
            }
        }

        function filterDropdowns(filter = null, event = null) {
            if (filter) {
                currentDropdownFilter = filter;
             
                document.querySelectorAll('#dropdowns .visa-filters .filter-btn').forEach(btn => btn.classList.remove('active'));
                if (event && event.target) {
                    event.target.classList.add('active');
                }
            } else {
           
                currentDropdownSearchTerm = document.getElementById('dropdownSearch').value || '';
            }
            renderDropdownGrid();
        }

        function sortDropdowns(sortBy, event = null) {
            currentDropdownSort = sortBy;
            
            document.querySelectorAll('#dropdowns .visa-filters .filter-btn').forEach(btn => {
                if (btn.textContent.includes('Sort by')) {
                    btn.classList.remove('active');
                }
            });
            if (event && event.target) {
            event.target.classList.add('active');
            }
            renderDropdownGrid();
        }

        function openDropdownModal(dropdownId = null) {
            const modal = document.getElementById('dropdownModal');
            const title = document.getElementById('dropdownModalTitle');
            const form = document.getElementById('dropdownForm');

            if (dropdownId) {
                const dropdown = dropdownOptions.find(d => d.id === dropdownId);
                title.textContent = 'Edit Dropdown Category';
                form.dataset.dropdownId = dropdownId;
                
                document.getElementById('dropdownName').value = dropdown.name;
                document.getElementById('dropdownDescription').value = dropdown.description;
                document.getElementById('dropdownOptions').value = dropdown.options.map(o => o.text).join('\n');
                document.getElementById('dropdownDefault').value = dropdown.defaultValue;
                document.getElementById('dropdownSortOrder').value = dropdown.sortOrder;
                document.getElementById('dropdownRequired').value = dropdown.required.toString();
                document.getElementById('dropdownActive').value = dropdown.active.toString();
            } else {
                title.textContent = 'Add Dropdown Category';
                form.dataset.dropdownId = '';
                form.reset();
                document.getElementById('dropdownRequired').value = 'true';
                document.getElementById('dropdownActive').value = 'true';
                document.getElementById('dropdownSortOrder').value = 'alphabetical';
            }

            modal.classList.add('active');
        }

        function closeDropdownModal() {
            document.getElementById('dropdownModal').classList.remove('active');
        }

        function editDropdown(dropdownId) {
            openDropdownModal(dropdownId);
        }

        function toggleDropdownStatus(dropdownId) {
            const dropdown = dropdownOptions.find(d => d.id === dropdownId);
            if (dropdown) {
                dropdown.active = !dropdown.active;
                saveDropdownOptions();
                loadDropdownOptions();
                showAlert(`Dropdown category ${dropdown.active ? 'activated' : 'deactivated'} successfully`, 'success');
            }
        }

        function deleteDropdown(dropdownId) {
            if (confirm('Are you sure you want to delete this dropdown category?')) {
                dropdownOptions = dropdownOptions.filter(d => d.id !== dropdownId);
                saveDropdownOptions();
                loadDropdownOptions();
                updateStats();
                showAlert('Dropdown category deleted successfully', 'success');
            }
        }

        function saveDropdownOptions() {
            localStorage.setItem('dropdownOptions', JSON.stringify(dropdownOptions));
        }

        
        function getDropdownOptions(categoryName) {
            const dropdown = dropdownOptions.find(d => d.name.toLowerCase() === categoryName.toLowerCase() && d.active);
            if (!dropdown) return [];
            
            let options = [...dropdown.options.filter(o => o.active)];
            
            
            switch (dropdown.sortOrder) {
                case 'alphabetical':
                    options.sort((a, b) => a.text.localeCompare(b.text));
                    break;
                case 'custom':
                    options.sort((a, b) => a.sortOrder - b.sortOrder);
                    break;
                case 'usage':
                    
                    break;
            }
            
            return options;
        }

     
        function exportDropdownOptions() {
            const exportData = {};
            dropdownOptions.forEach(dropdown => {
                if (dropdown.active) {
                    exportData[dropdown.name] = {
                        options: dropdown.options.filter(o => o.active).map(o => ({ value: o.value, text: o.text })),
                        defaultValue: dropdown.defaultValue,
                        required: dropdown.required
                    };
                }
            });
            return exportData;
        }

        
        function loadSettings() {
            document.getElementById('defaultCredits').value = settings.defaultCredits;
            document.getElementById('companyName').value = settings.companyName;
            document.getElementById('contactEmail').value = settings.contactEmail;
        }

        document.getElementById('visaForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const visaId = this.dataset.visaId;
            
            let description = '';
            if (tinymce.get('visaDescriptionEditor')) {
                description = tinymce.get('visaDescriptionEditor').getContent();
            } else if (window.quillEditor) {
                description = window.quillEditor.root.innerHTML;
            } else {
                description = document.getElementById('visaDescription').value.trim();
            }

            const visaData = {
                name: document.getElementById('visaName').value.trim(),
                description: description,
                processingTime: parseInt(document.getElementById('processingTime').value),
                basePrice: parseFloat(document.getElementById('basePrice').value),
                category: document.getElementById('visaCategory').value,
                requirements: document.getElementById('visaRequirements').value.split('\n').filter(req => req.trim()),
                active: document.getElementById('visaActive').value === 'true',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

          
            if (!visaData.name) {
                showAlert('Visa name is required', 'error');
                return;
            }
            if (visaData.processingTime < 1 || visaData.processingTime > 365) {
                showAlert('Processing time must be between 1 and 365 days', 'error');
                return;
            }
            if (visaData.basePrice < 0) {
                showAlert('Base price cannot be negative', 'error');
                return;
            }

            if (visaId) {
                
                const index = visaTypes.findIndex(v => v.id === parseInt(visaId));
                visaTypes[index] = { ...visaTypes[index], ...visaData };
            } else {
                
                visaData.id = Math.max(...visaTypes.map(v => v.id), 0) + 1;
                visaTypes.push(visaData);
            }

            saveVisaTypes();
            loadVisaTypes();
            updateStats();
            closeVisaModal();
            showAlert('Visa type saved successfully', 'success');
        });

        document.getElementById('packageForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const packageId = this.dataset.packageId;
            const packageData = {
                name: document.getElementById('packageName').value,
                price: parseFloat(document.getElementById('packagePrice').value),
                features: document.getElementById('packageFeatures').value.split('\n').filter(f => f.trim()),
                active: document.getElementById('packageActive').value === 'true'
            };

            if (packageId) {
                
                const index = packages.findIndex(p => p.id === parseInt(packageId));
                packages[index] = { ...packages[index], ...packageData };
            } else {
                
                packageData.id = Math.max(...packages.map(p => p.id), 0) + 1;
                packages.push(packageData);
            }

            savePackages();
            loadPackages();
            updateStats();
            closePackageModal();
            showAlert('Package saved successfully', 'success');
        });

        document.getElementById('settingsForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            settings = {
                defaultCredits: parseInt(document.getElementById('defaultCredits').value),
                companyName: document.getElementById('companyName').value,
                contactEmail: document.getElementById('contactEmail').value
            };

            saveSettings();
            showAlert('Settings saved successfully', 'success');
        });

        
        document.getElementById('dependentCostForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dependentCostId = this.dataset.dependentCostId;
            const visaTypeId = parseInt(document.getElementById('dependentVisaType').value);
            const visaType = visaTypes.find(v => v.id === visaTypeId);
            
            const dependentCostData = {
                visaTypeId: visaTypeId,
                visaTypeName: visaType ? visaType.name : 'Unknown Visa',
                dependentType: document.getElementById('dependentType').value,
                dependentTypeLabel: document.getElementById('dependentType').options[document.getElementById('dependentType').selectedIndex].text,
                additionalCost: parseFloat(document.getElementById('dependentCost').value),
                maxDependents: parseInt(document.getElementById('maxDependents').value) || null,
                processingTime: parseInt(document.getElementById('dependentProcessingTime').value) || 0,
                requirements: document.getElementById('dependentRequirements').value.split('\n').filter(req => req.trim()),
                notes: document.getElementById('dependentNotes').value.trim(),
                active: document.getElementById('dependentActive').value === 'true',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

          
            if (!dependentCostData.visaTypeId) {
                showAlert('Please select a visa type', 'error');
                return;
            }
            if (!dependentCostData.dependentType) {
                showAlert('Please select a dependent type', 'error');
                return;
            }
            if (dependentCostData.additionalCost < 0) {
                showAlert('Additional cost cannot be negative', 'error');
                return;
            }
            if (dependentCostData.maxDependents && dependentCostData.maxDependents < 0) {
                showAlert('Maximum dependents cannot be negative', 'error');
                return;
            }
            if (dependentCostData.processingTime < 0) {
                showAlert('Processing time cannot be negative', 'error');
                return;
            }

            if (dependentCostId) {
               
                const index = dependentCosts.findIndex(d => d.id === parseInt(dependentCostId));
                dependentCosts[index] = { ...dependentCosts[index], ...dependentCostData };
            } else {
                
                dependentCostData.id = Math.max(...dependentCosts.map(d => d.id), 0) + 1;
                dependentCosts.push(dependentCostData);
            }

            saveDependentCosts();
            loadDependentCosts();
            updateStats();
            closeDependentCostModal();
            showAlert('Dependent cost rule saved successfully', 'success');
        });

        
        document.getElementById('dropdownForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dropdownId = this.dataset.dropdownId;
            const optionsText = document.getElementById('dropdownOptions').value;
            const optionsList = optionsText.split('\n').filter(opt => opt.trim());
            
            const dropdownData = {
                name: document.getElementById('dropdownName').value.trim(),
                description: document.getElementById('dropdownDescription').value.trim(),
                options: optionsList.map((text, index) => ({
                    value: text.toLowerCase().replace(/\s+/g, '-'),
                    text: text.trim(),
                    sortOrder: index + 1,
                    active: true
                })),
                defaultValue: document.getElementById('dropdownDefault').value.trim(),
                sortOrder: document.getElementById('dropdownSortOrder').value,
                required: document.getElementById('dropdownRequired').value === 'true',
                active: document.getElementById('dropdownActive').value === 'true',
                usageCount: 0,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

           
            if (!dropdownData.name) {
                showAlert('Category name is required', 'error');
                return;
            }
            if (dropdownData.options.length === 0) {
                showAlert('At least one option is required', 'error');
                return;
            }

            if (dropdownId) {
              
                const index = dropdownOptions.findIndex(d => d.id === parseInt(dropdownId));
                const existingDropdown = dropdownOptions[index];
                dropdownData.id = existingDropdown.id;
                dropdownData.usageCount = existingDropdown.usageCount;
                dropdownData.createdAt = existingDropdown.createdAt;
                dropdownOptions[index] = dropdownData;
            } else {
            
                dropdownData.id = Math.max(...dropdownOptions.map(d => d.id), 0) + 1;
                dropdownOptions.push(dropdownData);
            }

            saveDropdownOptions();
            loadDropdownOptions();
            updateStats();
            closeDropdownModal();
            showAlert('Dropdown category saved successfully', 'success');
        });

        
        function saveVisaTypes() {
            localStorage.setItem('visaTypes', JSON.stringify(visaTypes));
        }

        function savePackages() {
            localStorage.setItem('packages', JSON.stringify(packages));
        }

        function saveSettings() {
            localStorage.setItem('settings', JSON.stringify(settings));
        }

        function saveDependentCosts() {
            localStorage.setItem('dependentCosts', JSON.stringify(dependentCosts));
        }

        function saveDropdownOptions() {
            localStorage.setItem('dropdownOptions', JSON.stringify(dropdownOptions));
        }

        
        function updateStats() {
            document.getElementById('totalVisas').textContent = visaTypes.filter(v => v.active).length;
            document.getElementById('totalPackages').textContent = packages.filter(p => p.active).length;
            
            if (document.getElementById('totalDropdowns')) {
                updateDropdownStats();
            }
        }

    
        function exportVisaTypes() {
            const dataStr = JSON.stringify(visaTypes, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'visa-types.json';
            link.click();
            URL.revokeObjectURL(url);
        }

        function exportDropdownOptionsToFile() {
            const exportData = exportDropdownOptions();
            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'dropdown-options.json';
            link.click();
            URL.revokeObjectURL(url);
            showAlert('Dropdown options exported successfully', 'success');
        }

        function importVisaTypes() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = function(e) {
                const file = e.target.files[0];
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const importedData = JSON.parse(e.target.result);
                        visaTypes = importedData;
                        saveVisaTypes();
                        loadVisaTypes();
                        updateStats();
                        showAlert('Visa types imported successfully', 'success');
                    } catch (error) {
                        showAlert('Error importing file. Please check the format.', 'error');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        function backupData() {
            const backup = {
                visaTypes,
                packages,
                dependentCosts,
                settings,
                timestamp: new Date().toISOString()
            };
            
            const dataStr = JSON.stringify(backup, null, 2);
            const dataBlob = new Blob([dataStr], { type: 'application/json' });
            const url = URL.createObjectURL(dataBlob);
            const link = document.createElement('a');
            link.href = url;
            link.download = `uk-visa-backup-${new Date().toISOString().split('T')[0]}.json`;
            link.click();
            URL.revokeObjectURL(url);
            
            showAlert('Backup created successfully', 'success');
        }

       
        async function loadChatData() {
            try {
               
                document.getElementById('chatList').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray);">
                        <i class="fas fa-spinner fa-spin" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Loading chat data...</h3>
                        <p>Please wait while we fetch the latest chat interactions</p>
                    </div>
                `;

            
                const params = new URLSearchParams({
                    action: 'get',
                    page: currentChatPage,
                    limit: chatItemsPerPage,
                    search: currentChatSearch,
                    filter: currentChatFilter
                });

               
                const response = await fetch(`public/track_chat.php?${params}`);
                const result = await response.json();

                if (result.status !== 'success') {
                    throw new Error(result.message || 'Failed to load chat data');
                }

              
                chatData = result.data;
                
                updateChatStats(result.stats);
                
              
                displayChats(result.data);
                
             
                updateChatPagination(result.pagination);
                
            } catch (error) {
                console.error('Error loading chat data:', error);
                
                const mockChatData = generateMockChatData();
                let filteredData = filterChatData(mockChatData);
                updateChatStats(filteredData);
                displayChats(filteredData);
                updateChatPagination(filteredData.length);
                
                document.getElementById('chatList').innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--warning);">
                        <i class="fas fa-exclamation-triangle" style="font-size: 3rem; margin-bottom: 1rem;"></i>
                        <h3>Using demo data</h3>
                        <p>API connection failed. Showing sample data for demonstration.</p>
                    </div>` + document.getElementById('chatList').innerHTML;
            }
        }

        function generateMockChatData() {
          
            const visaTypes = ['Business Visa', 'Student Visa', 'Family Visa', 'Work Visa', 'Tourist Visa', 'Partner Visa'];
            const questions = [
                'How do I apply for a UK business visa?',
                'What documents do I need for a student visa?',
                'How long does it take to process a family visa?',
                'Can I work in the UK with a tourist visa?',
                'What are the requirements for a partner visa?',
                'How much does a UK visa cost?',
                'Do I need to take an English test?',
                'Can I bring my family with me?',
                'What is the processing time for work visas?',
                'How do I extend my visa?'
            ];
            
            const responses = [
                'To apply for a UK business visa, you need to complete the online application form, provide required documents including business plan, financial statements, and attend a biometric appointment.',
                'For a UK student visa, you need a valid passport, CAS letter from your institution, proof of funds, English language certificate, and academic qualifications.',
                'Family visa processing typically takes 8-12 weeks, but can vary depending on your country of application and complexity of your case.',
                'No, you cannot work in the UK with a tourist visa. Tourist visas are for leisure and business visits only.',
                'Partner visa requirements include proof of relationship, financial requirements, English language skills, and accommodation arrangements.',
                'UK visa costs vary by type. Business visas start from 244, student visas from 348, and family visas from 1,523.',
                'Yes, most UK visa applications require proof of English language proficiency through tests like IELTS or TOEFL.',
                'Yes, you can bring dependents (spouse and children) with most visa types, subject to additional fees and requirements.',
                'Work visa processing times range from 3-8 weeks depending on the visa type and your country of application.',
                'To extend your visa, you must apply before your current visa expires and meet the eligibility criteria for extension.'
            ];

            const mockData = [];
            const now = new Date();
            
            for (let i = 0; i < 50; i++) {
                const timestamp = new Date(now.getTime() - Math.random() * 30 * 24 * 60 * 60 * 1000); // Random time in last 30 days
                const questionIndex = Math.floor(Math.random() * questions.length);
                const responseIndex = Math.floor(Math.random() * responses.length);
                const visaType = visaTypes[Math.floor(Math.random() * visaTypes.length)];
                
                mockData.push({
                    id: `chat_${i + 1}`,
                    windowId: `window_${Math.floor(Math.random() * 1000)}`,
                    timestamp: timestamp.toISOString(),
                    questionText: questions[questionIndex],
                    responseText: responses[responseIndex],
                    responseTime: (Math.random() * 5 + 1).toFixed(2), 
                    visaType: visaType,
                    userLocation: ['UK', 'India', 'Pakistan', 'Nigeria', 'China', 'USA'][Math.floor(Math.random() * 6)],
                    chatDuration: Math.floor(Math.random() * 300 + 60),
                    satisfaction: Math.floor(Math.random() * 5 + 1), 
                    followUp: Math.random() > 0.7 
                });
            }
            
            return mockData.sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp));
        }

        function filterChatData(data) {
            let filtered = [...data];
            
           
            if (currentChatSearch) {
                const searchTerm = currentChatSearch.toLowerCase();
                filtered = filtered.filter(chat => 
                    chat.questionText.toLowerCase().includes(searchTerm) ||
                    chat.responseText.toLowerCase().includes(searchTerm) ||
                    chat.visaType.toLowerCase().includes(searchTerm) ||
                    chat.userLocation.toLowerCase().includes(searchTerm)
                );
            }
            
            
            const now = new Date();
            switch (currentChatFilter) {
                case 'today':
                    const today = new Date(now.getFullYear(), now.getMonth(), now.getDate());
                    filtered = filtered.filter(chat => new Date(chat.timestamp) >= today);
                    break;
                case 'week':
                    const weekAgo = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
                    filtered = filtered.filter(chat => new Date(chat.timestamp) >= weekAgo);
                    break;
                case 'month':
                    const monthAgo = new Date(now.getTime() - 30 * 24 * 60 * 60 * 1000);
                    filtered = filtered.filter(chat => new Date(chat.timestamp) >= monthAgo);
                    break;
                case 'visa-related':
                    filtered = filtered.filter(chat => 
                        chat.questionText.toLowerCase().includes('visa') ||
                        chat.questionText.toLowerCase().includes('application') ||
                        chat.questionText.toLowerCase().includes('requirements')
                    );
                    break;
                case 'general':
                    filtered = filtered.filter(chat => 
                        !chat.questionText.toLowerCase().includes('visa') &&
                        !chat.questionText.toLowerCase().includes('application')
                    );
                    break;
            }
            
            return filtered;
        }

        function updateChatStats(stats) {
            document.getElementById('totalChats').textContent = stats.totalChats || 0;
            document.getElementById('totalQuestions').textContent = stats.totalQuestions || 0;
            document.getElementById('totalResponses').textContent = stats.totalResponses || 0;
            document.getElementById('avgResponseTime').textContent = `${stats.avgResponseTime || 0}s`;
        }

        function displayChats(data) {
            const chatList = document.getElementById('chatList');
            
            if (data.length === 0) {
                chatList.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: var(--gray);">
                        <i class="fas fa-search" style="font-size: 3rem; margin-bottom: 1rem; opacity: 0.5;"></i>
                        <h3>No chat conversations found</h3>
                        <p>Try adjusting your search or filters</p>
                    </div>
                `;
                return;
            }

        
            const startIndex = (currentChatPage - 1) * chatItemsPerPage;
            const endIndex = startIndex + chatItemsPerPage;
            const paginatedData = data.slice(startIndex, endIndex);

            let html = '';
            paginatedData.forEach(chat => {
                const timestamp = new Date(chat.timestamp);
                const timeAgo = getTimeAgo(timestamp);
                
                html += `
                    <div class="visa-item" onclick="openChatDetails('${chat.id}')" style="cursor: pointer;">
                        <div class="visa-header">
                            <div class="visa-name">${chat.visaType} - ${chat.userLocation}</div>
                            <div class="visa-description">${chat.questionText.substring(0, 100)}${chat.questionText.length > 100 ? '...' : ''}</div>
                        </div>
                        <div class="visa-details">
                            <div class="visa-detail">
                                <div class="visa-detail-label">Time Ago</div>
                                <div class="visa-detail-value">${timeAgo}</div>
                            </div>
                            <div class="visa-detail">
                                <div class="visa-detail-label">Response Time</div>
                                <div class="visa-detail-value">${chat.responseTime}s</div>
                            </div>
                            <div class="visa-detail">
                                <div class="visa-detail-label">Duration</div>
                                <div class="visa-detail-value">${Math.floor(chat.chatDuration / 60)}m</div>
                            </div>
                            <div class="visa-detail">
                                <div class="visa-detail-label">Rating</div>
                                <div class="visa-detail-value">${''.repeat(chat.satisfaction)}</div>
                            </div>
                        </div>
                        <div class="visa-actions">
                            <button class="btn btn-secondary btn-sm" onclick="event.stopPropagation(); openChatDetails('${chat.id}')" title="View Details">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-success btn-sm" onclick="event.stopPropagation(); markAsResolved('${chat.id}')" title="Mark Resolved">
                                <i class="fas fa-check"></i>
                            </button>
                            <button class="btn btn-danger btn-sm" onclick="event.stopPropagation(); deleteChat('${chat.id}')" title="Delete">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    </div>
                `;
            });

            chatList.innerHTML = html;
        }

        function updateChatPagination(pagination) {
            if (!pagination) return;
            
            const totalPages = pagination.totalPages || 1;
            const paginationElement = document.getElementById('chatPagination');
            const pageInfo = document.getElementById('chatPageInfo');
            const prevBtn = document.getElementById('prevChatBtn');
            const nextBtn = document.getElementById('nextChatBtn');

            if (totalPages <= 1) {
                paginationElement.style.display = 'none';
                return;
            }

            paginationElement.style.display = 'flex';
            pageInfo.textContent = `Page ${pagination.currentPage || 1} of ${totalPages}`;
            prevBtn.disabled = (pagination.currentPage || 1) === 1;
            nextBtn.disabled = (pagination.currentPage || 1) === totalPages;
        }

        function getTimeAgo(date) {
            const now = new Date();
            const diffInSeconds = Math.floor((now - date) / 1000);
            
            if (diffInSeconds < 60) return `${diffInSeconds}s ago`;
            if (diffInSeconds < 3600) return `${Math.floor(diffInSeconds / 60)}m ago`;
            if (diffInSeconds < 86400) return `${Math.floor(diffInSeconds / 3600)}h ago`;
            if (diffInSeconds < 2592000) return `${Math.floor(diffInSeconds / 86400)}d ago`;
            return `${Math.floor(diffInSeconds / 2592000)}mo ago`;
        }

        function refreshChatData() {
            loadChatData();
            showAlert('Chat data refreshed successfully', 'success');
        }

        async function exportChatData() {
            try {
               
                const exportBtn = event.target;
                const originalText = exportBtn.innerHTML;
                exportBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Exporting...';
                exportBtn.disabled = true;

            
                const params = new URLSearchParams({
                    action: 'get',
                    page: 1,
                    limit: 10000,
                    search: currentChatSearch,
                    filter: currentChatFilter
                });

                const response = await fetch(`public/track_chat.php?${params}`);
                const result = await response.json();

                if (result.status !== 'success') {
                    throw new Error(result.message || 'Failed to export chat data');
                }

                const csvContent = convertChatsToCSV(result.data);
                const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `uk-visa-chat-data-${new Date().toISOString().split('T')[0]}.csv`;
                link.click();
                URL.revokeObjectURL(url);
                
                showAlert('Chat data exported successfully', 'success');
            } catch (error) {
                console.error('Error exporting chat data:', error);
                showAlert('Failed to export chat data. Please try again.', 'error');
            } finally {
             
                const exportBtn = event.target;
                exportBtn.innerHTML = '<i class="fas fa-download"></i> Export CSV';
                exportBtn.disabled = false;
            }
        }

        function convertChatsToCSV(data) {
            const headers = ['Timestamp', 'Window ID', 'Visa Type', 'User Location', 'Question', 'Response', 'Response Time (s)', 'Chat Duration (s)', 'Satisfaction Rating', 'Follow Up'];
            const rows = data.map(chat => [
                chat.timestamp,
                chat.windowId,
                chat.visaType,
                chat.userLocation,
                `"${chat.questionText.replace(/"/g, '""')}"`,
                `"${chat.responseText.replace(/"/g, '""')}"`,
                chat.responseTime,
                chat.chatDuration,
                chat.satisfaction,
                chat.followUp ? 'Yes' : 'No'
            ]);
            return [headers, ...rows].map(row => row.join(',')).join('\n');
        }

        function openChatFilters() {
            const filters = document.getElementById('chatFilters');
            filters.style.display = filters.style.display === 'none' ? 'flex' : 'none';
        }

        function filterChats(filter) {
            currentChatFilter = filter;
            currentChatPage = 1;
            
  
            document.querySelectorAll('#chatFilters .filter-btn').forEach(btn => btn.classList.remove('active'));
            event.target.classList.add('active');
            
            loadChatData();
        }

        function searchChats() {
            currentChatSearch = document.getElementById('chatSearch').value;
            currentChatPage = 1;
            loadChatData();
        }

        function previousChatPage() {
            if (currentChatPage > 1) {
                currentChatPage--;
                loadChatData();
            }
        }

        function nextChatPage() {
            currentChatPage++;
            loadChatData();
        }

        function openChatDetails(chatId) {
            const chat = chatData.find(c => c.id === chatId);
            if (!chat) return;

            const modal = document.getElementById('chatDetailsModal');
            const content = document.getElementById('chatDetailsContent');
            
            content.innerHTML = `
                <div style="margin-bottom: 2rem;">
                    <div class="visa-details" style="grid-template-columns: repeat(4, 1fr);">
                        <div class="visa-detail">
                            <div class="visa-detail-label">Visa Type</div>
                            <div class="visa-detail-value">${chat.visaType}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">User Location</div>
                            <div class="visa-detail-value">${chat.userLocation}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Response Time</div>
                            <div class="visa-detail-value">${chat.responseTime}s</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Satisfaction</div>
                            <div class="visa-detail-value">${''.repeat(chat.satisfaction)}</div>
                        </div>
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--primary); margin-bottom: 0.5rem;">User Question:</h4>
                    <div style="background: var(--off-white); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--secondary);">
                        ${chat.questionText}
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--primary); margin-bottom: 0.5rem;">System Response:</h4>
                    <div style="background: var(--off-white); padding: 1rem; border-radius: 8px; border-left: 4px solid var(--success);">
                        ${chat.responseText}
                    </div>
                </div>
                
                <div style="margin-bottom: 1.5rem;">
                    <h4 style="color: var(--primary); margin-bottom: 0.5rem;">Additional Information:</h4>
                    <div class="visa-details" style="grid-template-columns: repeat(2, 1fr);">
                        <div class="visa-detail">
                            <div class="visa-detail-label">Chat Duration</div>
                            <div class="visa-detail-value">${Math.floor(chat.chatDuration / 60)}m ${chat.chatDuration % 60}s</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Follow Up Required</div>
                            <div class="visa-detail-value">${chat.followUp ? 'Yes' : 'No'}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Timestamp</div>
                            <div class="visa-detail-value">${new Date(chat.timestamp).toLocaleString()}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Window ID</div>
                            <div class="visa-detail-value">${chat.windowId}</div>
                        </div>
                    </div>
                </div>
                
                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="btn btn-primary" onclick="markAsResolved('${chat.id}')">
                        <i class="fas fa-check"></i> Mark as Resolved
                    </button>
                    <button class="btn btn-secondary" onclick="closeChatDetailsModal()">
                        Close
                    </button>
                </div>
            `;
            
            modal.classList.add('active');
        }

        function closeChatDetailsModal() {
            document.getElementById('chatDetailsModal').classList.remove('active');
        }

        function markAsResolved(chatId) {
            
            showAlert('Chat marked as resolved', 'success');
            closeChatDetailsModal();
        }

        function deleteChat(chatId) {
            if (confirm('Are you sure you want to delete this chat conversation?')) {
              
                chatData = chatData.filter(chat => chat.id !== chatId);
                loadChatData();
                showAlert('Chat conversation deleted successfully', 'success');
            }
        }

        function showAlert(message, type) {
            const alertDiv = document.createElement('div');
            alertDiv.className = `alert alert-${type}`;
            alertDiv.textContent = message;
            
            const mainContent = document.querySelector('.main-content');
            mainContent.insertBefore(alertDiv, mainContent.firstChild);
            
            setTimeout(() => {
                alertDiv.remove();
            }, 5000);
        }

       
        document.addEventListener('click', function(e) {
            if (e.target.classList.contains('modal')) {
                e.target.classList.remove('active');
            }
        });

      
        let applicantDropdownOptions = JSON.parse(localStorage.getItem('applicantDropdownOptions')) || [
            {
                id: 1,
                name: 'Income Range',
                description: 'Annual income ranges for additional applicants',
                options: [
                    { value: 'under-20k', text: 'Under 20,000', sortOrder: 1, active: true },
                    { value: '20k-40k', text: '20,000 - 40,000', sortOrder: 2, active: true },
                    { value: '40k-60k', text: '40,000 - 60,000', sortOrder: 3, active: true },
                    { value: '60k-80k', text: '60,000 - 80,000', sortOrder: 4, active: true },
                    { value: '80k-100k', text: '80,000 - 100,000', sortOrder: 5, active: true },
                    { value: 'over-100k', text: 'Over 100,000', sortOrder: 6, active: true }
                ],
                defaultValue: '',
                sortOrder: 'custom',
                required: false,
                active: true,
                usageCount: 0,
                category: 'employment'
            },
            {
                id: 2,
                name: 'Accommodation Type',
                description: 'Types of accommodation for additional applicants',
                options: [
                    { value: 'hotel', text: 'Hotel', sortOrder: 1, active: true },
                    { value: 'apartment', text: 'Apartment', sortOrder: 2, active: true },
                    { value: 'house', text: 'House', sortOrder: 3, active: true },
                    { value: 'hostel', text: 'Hostel', sortOrder: 4, active: true },
                    { value: 'guesthouse', text: 'Guesthouse', sortOrder: 5, active: true },
                    { value: 'family', text: 'Family/Friends', sortOrder: 6, active: true },
                    { value: 'other', text: 'Other', sortOrder: 7, active: true }
                ],
                defaultValue: '',
                sortOrder: 'alphabetical',
                required: false,
                active: true,
                usageCount: 0,
                category: 'travel'
            },
            {
                id: 3,
                name: 'Education Level',
                description: 'Education levels for additional applicants',
                options: [
                    { value: 'primary', text: 'Primary Education', sortOrder: 1, active: true },
                    { value: 'secondary', text: 'Secondary Education', sortOrder: 2, active: true },
                    { value: 'high-school', text: 'High School', sortOrder: 3, active: true },
                    { value: 'bachelor', text: 'Bachelor\'s Degree', sortOrder: 4, active: true },
                    { value: 'master', text: 'Master\'s Degree', sortOrder: 5, active: true },
                    { value: 'phd', text: 'PhD/Doctorate', sortOrder: 6, active: true },
                    { value: 'vocational', text: 'Vocational Training', sortOrder: 7, active: true },
                    { value: 'other', text: 'Other', sortOrder: 8, active: true }
                ],
                defaultValue: '',
                sortOrder: 'custom',
                required: false,
                active: true,
                usageCount: 0,
                category: 'personal'
            },
            {
                id: 4,
                name: 'Language Proficiency',
                description: 'Language proficiency levels for additional applicants',
                options: [
                    { value: 'native', text: 'Native Speaker', sortOrder: 1, active: true },
                    { value: 'fluent', text: 'Fluent', sortOrder: 2, active: true },
                    { value: 'advanced', text: 'Advanced', sortOrder: 3, active: true },
                    { value: 'intermediate', text: 'Intermediate', sortOrder: 4, active: true },
                    { value: 'basic', text: 'Basic', sortOrder: 5, active: true },
                    { value: 'beginner', text: 'Beginner', sortOrder: 6, active: true }
                ],
                defaultValue: '',
                sortOrder: 'custom',
                required: false,
                active: true,
                usageCount: 0,
                category: 'personal'
            }
        ];

        let currentApplicantDropdownFilter = 'all';
        let currentApplicantDropdownSort = 'name';
        let currentApplicantDropdownSearchTerm = '';
        let filteredApplicantDropdowns = [];

        function loadApplicantDropdownOptions() {
            updateApplicantDropdownStats();
            renderApplicantDropdownGrid();
            updateApplicantDropdownPreview();
        }

        function updateApplicantDropdownStats() {
            const totalDropdowns = applicantDropdownOptions.length;
            const activeDropdowns = applicantDropdownOptions.filter(d => d.active).length;
            const totalOptions = applicantDropdownOptions.reduce((sum, d) => sum + d.options.length, 0);
            const totalUsage = applicantDropdownOptions.reduce((sum, d) => sum + d.usageCount, 0);

            document.getElementById('totalApplicantDropdowns').textContent = totalDropdowns;
            document.getElementById('totalApplicantOptions').textContent = totalOptions;
            document.getElementById('activeApplicantDropdowns').textContent = activeDropdowns;
            document.getElementById('applicantUsageCount').textContent = totalUsage;
        }

        function renderApplicantDropdownGrid() {
            const dropdownList = document.getElementById('applicantDropdownList');
            dropdownList.innerHTML = '';

            filteredApplicantDropdowns = [...applicantDropdownOptions];
            
            if (currentApplicantDropdownFilter === 'active') {
                filteredApplicantDropdowns = filteredApplicantDropdowns.filter(d => d.active);
            } else if (currentApplicantDropdownFilter === 'inactive') {
                filteredApplicantDropdowns = filteredApplicantDropdowns.filter(d => !d.active);
            }

           
            if (currentApplicantDropdownSearchTerm && currentApplicantDropdownSearchTerm.trim() !== '') {
                const term = currentApplicantDropdownSearchTerm.toLowerCase();
                filteredApplicantDropdowns = filteredApplicantDropdowns.filter(dropdown =>
                    dropdown.name.toLowerCase().includes(term) ||
                    dropdown.description.toLowerCase().includes(term)
                );
            }

            filteredApplicantDropdowns.sort((a, b) => {
                switch (currentApplicantDropdownSort) {
                    case 'name':
                        return a.name.localeCompare(b.name);
                    case 'options':
                        return b.options.length - a.options.length;
                    case 'usage':
                        return b.usageCount - a.usageCount;
                    default:
                        return 0;
                }
            });

            filteredApplicantDropdowns.forEach(dropdown => {
                const dropdownItem = document.createElement('div');
                dropdownItem.className = `visa-item ${dropdown.active ? 'active' : 'inactive'}`;
                dropdownItem.innerHTML = `
                    <div class="visa-status ${dropdown.active ? 'active' : 'inactive'}">
                        ${dropdown.active ? 'Active' : 'Inactive'}
                    </div>
                    <div class="visa-header">
                        <div class="visa-name">${dropdown.name}</div>
                        <div class="visa-description">${dropdown.description}</div>
                    </div>
                    <div class="visa-details">
                        <div class="visa-detail">
                            <div class="visa-detail-label">Options</div>
                            <div class="visa-detail-value">${dropdown.options.length}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Category</div>
                            <div class="visa-detail-value">${dropdown.category || 'General'}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Usage</div>
                            <div class="visa-detail-value">${dropdown.usageCount}</div>
                        </div>
                        <div class="visa-detail">
                            <div class="visa-detail-label">Required</div>
                            <div class="visa-detail-value">${dropdown.required ? 'Yes' : 'No'}</div>
                        </div>
                    </div>
                    <div class="visa-actions">
                        <button class="btn btn-sm btn-secondary" onclick="editApplicantDropdown(${dropdown.id})">
                            <i class="fas fa-edit"></i> Edit
                        </button>
                        <button class="btn btn-sm ${dropdown.active ? 'btn-warning' : 'btn-success'}" onclick="toggleApplicantDropdownStatus(${dropdown.id})">
                            <i class="fas fa-${dropdown.active ? 'pause' : 'play'}"></i> ${dropdown.active ? 'Deactivate' : 'Activate'}
                        </button>
                        <button class="btn btn-sm btn-danger" onclick="deleteApplicantDropdown(${dropdown.id})">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                `;
                dropdownList.appendChild(dropdownItem);
            });
        }

        function updateApplicantDropdownPreview() {
            const previewMappings = {
                'preview-nationality': 'Nationality',
                'preview-gender': 'Gender',
                'preview-relationship': 'Relationship Type',
                'preview-employmentStatus': 'Employment Status',
                'preview-incomeRange': 'Income Range',
                'preview-travelPurpose': 'Travel Purpose',
                'preview-accommodationType': 'Accommodation Type'
            };

            Object.keys(previewMappings).forEach(previewId => {
                const selectElement = document.getElementById(previewId);
                if (selectElement) {
                    const categoryName = previewMappings[previewId];
                    const dropdown = applicantDropdownOptions.find(d => 
                        d.name.toLowerCase() === categoryName.toLowerCase() && d.active
                    ) || dropdownOptions.find(d => 
                        d.name.toLowerCase() === categoryName.toLowerCase() && d.active
                    );
                    
                    if (dropdown) {
                        const placeholderOption = selectElement.querySelector('option[value=""]');
                        selectElement.innerHTML = '';
                        if (placeholderOption) {
                            selectElement.appendChild(placeholderOption);
                        }
                        
                        dropdown.options.forEach(option => {
                            if (option.active) {
                                const optionElement = document.createElement('option');
                                optionElement.value = option.value;
                                optionElement.textContent = option.text;
                                selectElement.appendChild(optionElement);
                            }
                        });
                    }
                }
            });
        }

        function openApplicantDropdownModal(dropdownId = null) {
            const modal = document.getElementById('applicantDropdownModal');
            const title = document.getElementById('applicantDropdownModalTitle');
            const form = document.getElementById('applicantDropdownForm');

            if (dropdownId) {
                const dropdown = applicantDropdownOptions.find(d => d.id === dropdownId);
                title.textContent = 'Edit Applicant Dropdown';
                form.dataset.dropdownId = dropdownId;
                
                document.getElementById('applicantDropdownName').value = dropdown.name;
                document.getElementById('applicantDropdownDescription').value = dropdown.description;
                document.getElementById('applicantDropdownOptions').value = dropdown.options.map(o => o.text).join('\n');
                document.getElementById('applicantDropdownSortOrder').value = dropdown.sortOrder;
                document.getElementById('applicantDropdownActive').value = dropdown.active.toString();
            } else {
                title.textContent = 'Add Applicant Dropdown';
                form.dataset.dropdownId = '';
                form.reset();
                document.getElementById('applicantDropdownActive').value = 'true';
                document.getElementById('applicantDropdownSortOrder').value = 'alphabetical';
            }

            modal.classList.add('active');
        }

        function closeApplicantDropdownModal() {
            document.getElementById('applicantDropdownModal').classList.remove('active');
        }

        function setupApplicantDropdownForm() {
            document.getElementById('applicantDropdownForm').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const dropdownId = this.dataset.dropdownId;
                const dropdownData = {
                    name: document.getElementById('applicantDropdownName').value,
                    description: document.getElementById('applicantDropdownDescription').value,
                    options: document.getElementById('applicantDropdownOptions').value.split('\n')
                        .filter(line => line.trim())
                        .map((line, index) => ({
                            id: Date.now() + index,
                            text: line.trim(),
                            active: true,
                            sortOrder: index
                        })),
                    sortOrder: document.getElementById('applicantDropdownSortOrder').value,
                    active: document.getElementById('applicantDropdownActive').value === 'true'
                };

              
                if (!dropdownData.name) {
                    showAlert('Category name is required', 'error');
                    return;
                }
                if (dropdownData.options.length === 0) {
                    showAlert('At least one option is required', 'error');
                    return;
                }

                if (dropdownId) {
                  
                    const index = applicantDropdownOptions.findIndex(d => d.id == dropdownId);
                    if (index !== -1) {
                        applicantDropdownOptions[index] = { ...applicantDropdownOptions[index], ...dropdownData };
                    }
                } else {
                  
                    dropdownData.id = Date.now();
                    applicantDropdownOptions.push(dropdownData);
                }

                saveApplicantDropdownOptions();
                loadApplicantDropdownOptions();
                updateStats();
                closeApplicantDropdownModal();
                showAlert('Applicant dropdown category saved successfully', 'success');
            });
        }

        function editApplicantDropdown(dropdownId) {
            openApplicantDropdownModal(dropdownId);
        }

        function toggleApplicantDropdownStatus(dropdownId) {
            const dropdown = applicantDropdownOptions.find(d => d.id === dropdownId);
            if (dropdown) {
                dropdown.active = !dropdown.active;
                saveApplicantDropdownOptions();
                loadApplicantDropdownOptions();
                showAlert(`Applicant dropdown category ${dropdown.active ? 'activated' : 'deactivated'} successfully`, 'success');
            }
        }

        function deleteApplicantDropdown(dropdownId) {
            if (confirm('Are you sure you want to delete this applicant dropdown category?')) {
                applicantDropdownOptions = applicantDropdownOptions.filter(d => d.id !== dropdownId);
                saveApplicantDropdownOptions();
                loadApplicantDropdownOptions();
                updateStats();
                showAlert('Applicant dropdown category deleted successfully', 'success');
            }
        }

        function saveApplicantDropdownOptions() {
            localStorage.setItem('applicantDropdownOptions', JSON.stringify(applicantDropdownOptions));
        }

        function filterApplicantDropdowns(filter, event) {
            if (typeof filter === 'string') {
                currentApplicantDropdownFilter = filter;
                if (event) {
                    document.querySelectorAll('#applicant-dropdowns .filter-btn').forEach(btn => btn.classList.remove('active'));
                    event.target.classList.add('active');
                }
            } else {
                
                currentApplicantDropdownSearchTerm = document.getElementById('applicantDropdownSearch').value || '';
            }
            renderApplicantDropdownGrid();
        }

        function sortApplicantDropdowns(sort, event) {
            currentApplicantDropdownSort = sort;
            
            if (event) {
                document.querySelectorAll('#applicant-dropdowns .filter-btn').forEach(btn => btn.classList.remove('active'));
                event.target.classList.add('active');
            }
            
            renderApplicantDropdownGrid();
        }

        function showQuickAddApplicantDropdownMenu() {
            const menu = document.createElement('div');
            menu.className = 'modal active';
            menu.innerHTML = `
                <div class="modal-content" style="max-width: 600px;">
                    <div class="modal-header">
                        <h3 class="modal-title">Quick Add Applicant Dropdown Templates</h3>
                        <button class="close-btn" onclick="this.closest('.modal').remove()">&times;</button>
                    </div>
                    <div style="padding: 1.5rem;">
                        <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 1rem;">
                            <button class="btn btn-secondary" onclick="quickAddApplicantDropdown('Marital Status', 'Marital status options for additional applicants', 'Single\nMarried\nDivorced\nWidowed\nSeparated\nCivil Partnership')">
                                <i class="fas fa-heart"></i> Marital Status
                            </button>
                            <button class="btn btn-secondary" onclick="quickAddApplicantDropdown('Occupation Type', 'Occupation categories for additional applicants', 'Professional\nSkilled Worker\nUnskilled Worker\nStudent\nRetired\nUnemployed\nSelf-Employed')">
                                <i class="fas fa-briefcase"></i> Occupation Type
                            </button>
                            <button class="btn btn-secondary" onclick="quickAddApplicantDropdown('Previous Travel', 'Previous travel experience for additional applicants', 'None\n1-2 times\n3-5 times\n6-10 times\nMore than 10 times')">
                                <i class="fas fa-plane"></i> Previous Travel
                            </button>
                            <button class="btn btn-secondary" onclick="quickAddApplicantDropdown('Health Status', 'Health status options for additional applicants', 'Excellent\nGood\nFair\nPoor\nPrefer not to say')">
                                <i class="fas fa-heartbeat"></i> Health Status
                            </button>
                            <button class="btn btn-secondary" onclick="quickAddApplicantDropdown('Emergency Contact', 'Emergency contact relationship types', 'Spouse\nParent\nSibling\nChild\nFriend\nColleague\nOther')">
                                <i class="fas fa-phone"></i> Emergency Contact
                            </button>
                            <button class="btn btn-secondary" onclick="quickAddApplicantDropdown('Document Type', 'Types of supporting documents', 'Passport\nBirth Certificate\nMarriage Certificate\nEmployment Letter\nBank Statement\nUtility Bill\nOther')">
                                <i class="fas fa-file"></i> Document Type
                            </button>
                        </div>
                    </div>
                </div>
            `;
            document.body.appendChild(menu);
        }

        function quickAddApplicantDropdown(name, description, optionsText) {
            const dropdownData = {
                id: Math.max(...applicantDropdownOptions.map(d => d.id), 0) + 1,
                name: name,
                description: description,
                options: optionsText.split('\n').map((text, index) => ({
                    value: text.toLowerCase().replace(/\s+/g, '-').replace(/[^a-z0-9-]/g, ''),
                    text: text.trim(),
                    sortOrder: index + 1,
                    active: true
                })),
                defaultValue: '',
                sortOrder: 'alphabetical',
                required: false,
                active: true,
                usageCount: 0,
                category: 'general',
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            applicantDropdownOptions.push(dropdownData);
            saveApplicantDropdownOptions();
            loadApplicantDropdownOptions();
            document.querySelector('.modal').remove();
            showAlert(`${name} applicant dropdown category added successfully`, 'success');
        }

       
        document.getElementById('dropdownForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            const dropdownId = this.dataset.dropdownId;
            const dropdownType = this.dataset.dropdownType;
            const optionsText = document.getElementById('dropdownOptions').value;
            const optionsList = optionsText.split('\n').filter(opt => opt.trim());
            
            const dropdownData = {
                name: document.getElementById('dropdownName').value.trim(),
                description: document.getElementById('dropdownDescription').value.trim(),
                options: optionsList.map((text, index) => ({
                    value: text.toLowerCase().replace(/\s+/g, '-'),
                    text: text.trim(),
                    sortOrder: index + 1,
                    active: true
                })),
                defaultValue: document.getElementById('dropdownDefault').value.trim(),
                sortOrder: document.getElementById('dropdownSortOrder').value,
                required: document.getElementById('dropdownRequired').value === 'true',
                active: document.getElementById('dropdownActive').value === 'true',
                usageCount: 0,
                createdAt: new Date().toISOString(),
                updatedAt: new Date().toISOString()
            };

            if (dropdownType === 'applicant') {
                dropdownData.category = 'general';
                dropdownData.id = dropdownId ? parseInt(dropdownId) : Math.max(...applicantDropdownOptions.map(d => d.id), 0) + 1;
                
                if (dropdownId) {
                    const index = applicantDropdownOptions.findIndex(d => d.id === parseInt(dropdownId));
                    const existingDropdown = applicantDropdownOptions[index];
                    dropdownData.usageCount = existingDropdown.usageCount;
                    dropdownData.createdAt = existingDropdown.createdAt;
                    applicantDropdownOptions[index] = dropdownData;
                } else {
                    applicantDropdownOptions.push(dropdownData);
                }
                
                saveApplicantDropdownOptions();
                loadApplicantDropdownOptions();
            } else {
             
                if (dropdownId) {
                    const index = dropdownOptions.findIndex(d => d.id === parseInt(dropdownId));
                    const existingDropdown = dropdownOptions[index];
                    dropdownData.id = existingDropdown.id;
                    dropdownData.usageCount = existingDropdown.usageCount;
                    dropdownData.createdAt = existingDropdown.createdAt;
                    dropdownOptions[index] = dropdownData;
                } else {
                    dropdownData.id = Math.max(...dropdownOptions.map(d => d.id), 0) + 1;
                    dropdownOptions.push(dropdownData);
                }
                
                saveDropdownOptions();
                loadDropdownOptions();
            }

            updateStats();
            closeDropdownModal();
            showAlert('Dropdown category saved successfully', 'success');
        });

  


        
        let currentFolder = 'root';
        let selectedFiles = [];
        let fileList = [];
        let uploadQueue = [];

     
        const sampleFiles = [
            { id: 1, name: 'visa-application-guide.pdf', type: 'document', size: '2.5 MB', path: 'documents/', date: '2024-01-15', icon: 'fas fa-file-pdf' },
            { id: 2, name: 'passport-template.jpg', type: 'image', size: '1.2 MB', path: 'images/', date: '2024-01-14', icon: 'fas fa-image' },
            { id: 3, name: 'application-form.docx', type: 'document', size: '850 KB', path: 'templates/', date: '2024-01-13', icon: 'fas fa-file-word' },
            { id: 4, name: 'company-logo.png', type: 'image', size: '500 KB', path: 'images/', date: '2024-01-12', icon: 'fas fa-image' },
            { id: 5, name: 'visa-requirements.zip', type: 'archive', size: '5.1 MB', path: 'documents/', date: '2024-01-11', icon: 'fas fa-file-archive' },
            { id: 6, name: 'interview-questions.txt', type: 'document', size: '45 KB', path: 'templates/', date: '2024-01-10', icon: 'fas fa-file-alt' }
        ];

        
        function initializeFileManager() {
            fileList = [...sampleFiles];
            loadFiles();
            setupFileUploadHandlers();
        }

        
        function loadFiles() {
            const fileListElement = document.getElementById('fileList');
            if (!fileListElement) return;

            const filteredFiles = fileList.filter(file => file.path === currentFolder + '/');
            
            if (filteredFiles.length === 0) {
                fileListElement.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-folder-open" style="font-size: 3rem; color: var(--gray); margin-bottom: 1rem;"></i>
                        <h3>No files in this folder</h3>
                        <p>Upload some files to get started</p>
                        <button class="btn btn-primary" onclick="openFileUploadModal()">
                            <i class="fas fa-upload"></i>
                            Upload Files
                        </button>
                    </div>
                `;
                return;
            }

            fileListElement.innerHTML = filteredFiles.map(file => createFileItem(file)).join('');
        }

        
        function createFileItem(file) {
            const isSelected = selectedFiles.includes(file.id);
            return `
                <div class="file-item ${isSelected ? 'selected' : ''}" onclick="toggleFileSelection(${file.id})">
                    <div class="file-icon">
                        <i class="${file.icon}"></i>
                    </div>
                    <div class="file-info">
                        <div class="file-name">${file.name}</div>
                        <div class="file-meta">${file.size}  ${formatDate(file.date)}</div>
                    </div>
                    <div class="file-actions">
                        <button class="file-action-btn" onclick="event.stopPropagation(); downloadFile(${file.id})" title="Download">
                            <i class="fas fa-download"></i>
                        </button>
                        <button class="file-action-btn" onclick="event.stopPropagation(); editFile(${file.id})" title="Edit">
                            <i class="fas fa-edit"></i>
                        </button>
                        <button class="file-action-btn" onclick="event.stopPropagation(); deleteFile(${file.id})" title="Delete">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            `;
        }

       
        function toggleFileSelection(fileId) {
            const index = selectedFiles.indexOf(fileId);
            if (index > -1) {
                selectedFiles.splice(index, 1);
            } else {
                selectedFiles.push(fileId);
            }
            loadFiles(); 
        }

      
        function navigateToFolder(folder) {
            currentFolder = folder;
            selectedFiles = [];
            updateBreadcrumb();
            loadFiles();
        }

        
        function updateBreadcrumb() {
            const breadcrumbElement = document.getElementById('currentPath');
            if (breadcrumbElement) {
                breadcrumbElement.textContent = '/' + currentFolder;
            }
        }

        
        function openFileUploadModal() {
            document.getElementById('fileUploadModal').classList.add('active');
            uploadQueue = [];
            document.getElementById('filePreview').innerHTML = '';
        }

        function closeFileUploadModal() {
            document.getElementById('fileUploadModal').classList.remove('active');
            uploadQueue = [];
            document.getElementById('fileInput').value = '';
        }

    
        function setupFileUploadHandlers() {
            const fileInput = document.getElementById('fileInput');
            const uploadArea = document.getElementById('fileUploadArea');

        
            fileInput.addEventListener('change', handleFileSelect);

            
            uploadArea.addEventListener('dragover', (e) => {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', () => {
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', (e) => {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                const files = Array.from(e.dataTransfer.files);
                handleFiles(files);
            });
        }


        function handleFileSelect(e) {
            const files = Array.from(e.target.files);
            handleFiles(files);
        }

    
        function handleFiles(files) {
            files.forEach(file => {
                if (file.size > 50 * 1024 * 1024) { 
                    showAlert(`File ${file.name} is too large.3
                    
                    Maximum size is 50MB.`, 'error');
                    return;
                }

                const fileData = {
                    id: Date.now() + Math.random(),
                    file: file,
                    name: file.name,
                    size: formatFileSize(file.size),
                    type: getFileType(file.name),
                    icon: getFileIcon(file.name)
                };

                uploadQueue.push(fileData);
            });

            updateFilePreview();
        }

        
        function updateFilePreview() {
            const previewElement = document.getElementById('filePreview');
            previewElement.innerHTML = uploadQueue.map(file => `
                <div class="file-preview-item">
                    <div class="file-icon">
                        <i class="${file.icon}"></i>
                    </div>
                    <div class="file-name">${file.name}</div>
                    <div class="file-size">${file.size}</div>
                    <button class="remove-file" onclick="removeFileFromQueue(${file.id})">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `).join('');
        }

        function removeFileFromQueue(fileId) {
            uploadQueue = uploadQueue.filter(file => file.id !== fileId);
            updateFilePreview();
        }

        
        function uploadFiles() {
            if (uploadQueue.length === 0) {
                showAlert('Please select files to upload', 'warning');
                return;
            }

            const folder = document.getElementById('uploadFolder').value;
            
           
            uploadQueue.forEach((fileData, index) => {
                setTimeout(() => {
                    const newFile = {
                        id: fileData.id,
                        name: fileData.name,
                        type: fileData.type,
                        size: fileData.size,
                        path: folder + '/',
                        date: new Date().toISOString().split('T')[0],
                        icon: fileData.icon
                    };

                    fileList.push(newFile);
                    
                    if (index === uploadQueue.length - 1) {
                        closeFileUploadModal();
                        loadFiles();
                        showAlert(`${uploadQueue.length} file(s) uploaded successfully`, 'success');
                    }
                }, index * 500); 
            });
        }


        function downloadFile(fileId) {
            const file = fileList.find(f => f.id === fileId);
            if (file) {
                
                showAlert(`Downloading ${file.name}...`, 'info');
            }
        }

        function editFile(fileId) {
            const file = fileList.find(f => f.id === fileId);
            if (file) {
                
                showAlert(`Opening ${file.name} for editing...`, 'info');
            }
        }

        function deleteFile(fileId) {
            const file = fileList.find(f => f.id === fileId);
            if (file && confirm(`Are you sure you want to delete ${file.name}?`)) {
                fileList = fileList.filter(f => f.id !== fileId);
                selectedFiles = selectedFiles.filter(id => id !== fileId);
                loadFiles();
                showAlert(`${file.name} deleted successfully`, 'success');
            }
        }

    
        function createNewFolder() {
            const folderName = prompt('Enter folder name:');
            if (folderName && folderName.trim()) {
            
                showAlert(`Folder "${folderName}" created successfully`, 'success');
            }
        }

    
        function refreshFileList() {
            loadFiles();
            showAlert('File list refreshed', 'info');
        }

        
        function changeFileViewMode() {
            const viewMode = document.getElementById('fileViewMode').value;
            const fileListElement = document.getElementById('fileList');
            
            if (viewMode === 'list') {
                fileListElement.classList.add('list-view');
            } else {
                fileListElement.classList.remove('list-view');
            }
        }

    
        function filterByType() {
            const checkboxes = document.querySelectorAll('.filter-checkbox input[type="checkbox"]');
            const selectedTypes = Array.from(checkboxes)
                .filter(cb => cb.checked)
                .map(cb => cb.value);
            
            
            console.log('Filtering by types:', selectedTypes);
        }

        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }

        function formatDate(dateString) {
            const date = new Date(dateString);
            return date.toLocaleDateString();
        }

        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            const imageExts = ['jpg', 'jpeg', 'png', 'gif', 'bmp', 'webp'];
            const docExts = ['pdf', 'doc', 'docx', 'txt', 'rtf'];
            const archiveExts = ['zip', 'rar', '7z', 'tar', 'gz'];
            
            if (imageExts.includes(ext)) return 'image';
            if (docExts.includes(ext)) return 'document';
            if (archiveExts.includes(ext)) return 'archive';
            return 'other';
        }

        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            
            switch (ext) {
                case 'pdf': return 'fas fa-file-pdf';
                case 'doc':
                case 'docx': return 'fas fa-file-word';
                case 'xls':
                case 'xlsx': return 'fas fa-file-excel';
                case 'ppt':
                case 'pptx': return 'fas fa-file-powerpoint';
                case 'txt': return 'fas fa-file-alt';
                case 'zip':
                case 'rar': return 'fas fa-file-archive';
                case 'jpg':
                case 'jpeg':
                case 'png':
                case 'gif': return 'fas fa-image';
                default: return 'fas fa-file';
            }
        }


    </script>
</body>
</html>